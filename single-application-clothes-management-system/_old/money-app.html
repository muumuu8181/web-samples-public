<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ „ÅäÈáëÁÆ°ÁêÜ„Ç¢„Éó„É™ - Firebase & Node.js</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary: #2E8B57;
            --success: #4CAF50;
            --danger: #f44336;
            --warning: #FF9800;
            --info: #2196F3;
            --bg: #f8f9fa;
            --surface: #fff;
            --text: #333;
            --border: #ddd;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* „Éò„ÉÉ„ÉÄ„Éº */
        header {
            background: var(--surface);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        h1 {
            color: var(--primary);
            font-size: 1.8rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auth-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .auth-btn:hover {
            opacity: 0.9;
        }

        /* „Ç∞„É™„ÉÉ„Éâ„É¨„Ç§„Ç¢„Ç¶„Éà */
        .app-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .section {
            background: var(--surface);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .section h3 {
            margin-bottom: 15px;
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 5px;
        }

        /* „Éï„Ç©„Éº„É† */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            height: 80px;
        }

        .form-row {
            display: flex;
            gap: 10px;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* „Éú„Çø„É≥ */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-info {
            background: var(--info);
        }

        .btn-warning {
            background: var(--warning);
        }

        /* ÂèñÂºï„É™„Çπ„Éà */
        .transaction-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 8px;
            background: var(--surface);
        }

        .transaction-income {
            border-left: 4px solid var(--success);
        }

        .transaction-expense {
            border-left: 4px solid var(--danger);
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-amount {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .amount-income {
            color: var(--success);
        }

        .amount-expense {
            color: var(--danger);
        }

        .transaction-meta {
            font-size: 0.9rem;
            color: #666;
        }

        /* Áµ±Ë®àÊÉÖÂ†± */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: var(--bg);
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        /* „Éï„Ç£„É´„Çø„Éº */
        .filter-section {
            background: var(--bg);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        /* „É≠„Ç∞„Çª„ÇØ„Ç∑„Éß„É≥ */
        .log-section {
            grid-column: 1 / -1;
        }

        .log-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .debug-logs {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-line;
        }

        /* „É¨„Çπ„Éù„É≥„Ç∑„Éñ */
        @media (max-width: 768px) {
            .app-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* „É≠„Éº„Éá„Ç£„É≥„Ç∞ */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- „Éò„ÉÉ„ÉÄ„Éº -->
        <header>
            <h1>üí∞ „ÅäÈáëÁÆ°ÁêÜ„Ç¢„Éó„É™</h1>
            <div class="user-info" id="userInfo">
                <button class="auth-btn" id="authBtn">Google„Åß„É≠„Ç∞„Ç§„É≥</button>
            </div>
        </header>

        <!-- „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
        <div class="app-grid">
            <!-- ÂèñÂºïËøΩÂä†„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="section">
                <h3>üí≥ ÂèñÂºïËøΩÂä†</h3>
                <form id="transactionForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transactionType">„Çø„Ç§„Éó</label>
                            <select id="transactionType" required>
                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                <option value="income">ÂèéÂÖ•</option>
                                <option value="expense">ÊîØÂá∫</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="transactionAmount">ÈáëÈ°ç</label>
                            <input type="number" id="transactionAmount" placeholder="0" min="0" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transactionCategory">„Ç´„ÉÜ„Ç¥„É™</label>
                            <select id="transactionCategory" required>
                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="transactionDate">Êó•‰ªò</label>
                            <input type="date" id="transactionDate" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="transactionDescription">Ë©≥Á¥∞</label>
                        <textarea id="transactionDescription" placeholder="ÂèñÂºï„ÅÆË©≥Á¥∞„ÇíÂÖ•Âäõ"></textarea>
                    </div>
                    
                    <button type="submit" class="btn">ÂèñÂºï„ÇíËøΩÂä†</button>
                    <button type="button" class="btn btn-warning" onclick="generateSampleData()">„Çµ„É≥„Éó„É´„Éá„Éº„ÇøÁîüÊàê</button>
                </form>
            </div>

            <!-- Áµ±Ë®àÊÉÖÂ†±„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="section">
                <h3>üìä Áµ±Ë®àÊÉÖÂ†±</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value amount-income" id="totalIncome">¬•0</div>
                        <div class="stat-label">Á∑èÂèéÂÖ•</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value amount-expense" id="totalExpense">¬•0</div>
                        <div class="stat-label">Á∑èÊîØÂá∫</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="balance">¬•0</div>
                        <div class="stat-label">ÊÆãÈ´ò</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="transactionCount">0</div>
                        <div class="stat-label">ÂèñÂºïÊï∞</div>
                    </div>
                </div>
                
                <div class="log-controls">
                    <button class="btn btn-success" onclick="exportCSV()">üìä CSVÂá∫Âäõ</button>
                    <button class="btn btn-info" onclick="loadTransactions()">üîÑ Êõ¥Êñ∞</button>
                    <button class="btn btn-warning" onclick="downloadLogs()">üì• „É≠„Ç∞DL</button>
                </div>
            </div>

            <!-- ÂèñÂºïÂ±•Ê≠¥„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="section">
                <h3>üìã ÂèñÂºïÂ±•Ê≠¥</h3>
                
                <div class="filter-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="filterStartDate">ÈñãÂßãÊó•</label>
                            <input type="date" id="filterStartDate">
                        </div>
                        <div class="form-group">
                            <label for="filterEndDate">ÁµÇ‰∫ÜÊó•</label>
                            <input type="date" id="filterEndDate">
                        </div>
                        <div class="form-group">
                            <label for="filterType">„Çø„Ç§„Éó</label>
                            <select id="filterType">
                                <option value="">„Åô„Åπ„Å¶</option>
                                <option value="income">ÂèéÂÖ•</option>
                                <option value="expense">ÊîØÂá∫</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-info" onclick="applyFilters()">„Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®</button>
                </div>
                
                <div class="transaction-list" id="transactionList">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        ÂèñÂºï„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì
                    </div>
                </div>
            </div>

            <!-- ÊúàÊ¨°„É¨„Éù„Éº„Éà„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="section">
                <h3>üìÖ ÊúàÊ¨°„É¨„Éù„Éº„Éà</h3>
                
                <div class="form-row" style="margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="reportYear">Âπ¥</label>
                        <select id="reportYear"></select>
                    </div>
                    <div class="form-group">
                        <label for="reportMonth">Êúà</label>
                        <select id="reportMonth"></select>
                    </div>
                    <div class="form-group">
                        <button class="btn" onclick="generateMonthlyReport()" style="margin-top: 25px;">„É¨„Éù„Éº„ÉàÁîüÊàê</button>
                    </div>
                </div>
                
                <div id="monthlyReportContent">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        „É¨„Éù„Éº„Éà„ÇíÁîüÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                    </div>
                </div>
            </div>

            <!-- „É≠„Ç∞„Çª„ÇØ„Ç∑„Éß„É≥ -->
            <div class="section log-section">
                <h3>üìä „Ç∑„Çπ„ÉÜ„É†„É≠„Ç∞</h3>
                <div class="log-controls">
                    <button class="btn" onclick="downloadLogs()">üì• „É≠„Ç∞„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ</button>
                    <button class="btn" onclick="clearLogs()">üóëÔ∏è „É≠„Ç∞„ÇØ„É™„Ç¢</button>
                    <button class="btn" onclick="testAPI()">üîó API „ÉÜ„Çπ„Éà</button>
                </div>
                <div class="debug-logs" id="debugLogs">„Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ‰∏≠...</div>
            </div>
        </div>
    </div>

    <script>
        // FirebaseË®≠ÂÆö
        const firebaseConfig = {
            apiKey: "AIzaSyA5PXKChizYDCXF_GJ4KL6Ylq9K5hCPXWE",
            authDomain: "shares-b1b97.firebaseapp.com",
            databaseURL: "https://shares-b1b97-default-rtdb.firebaseio.com",
            projectId: "shares-b1b97",
            storageBucket: "shares-b1b97.appspot.com",
            messagingSenderId: "927474832426",
            appId: "1:927474832426:web:8a8d8d8d8d8d8d8d8d8d8d"
        };

        // FirebaseÂàùÊúüÂåñ
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // „ÅäÈáëÁÆ°ÁêÜ„Ç¢„Éó„É™„ÇØ„É©„Çπ
        class MoneyAppClient {
            constructor() {
                this.currentUser = null;
                this.transactions = [];
                this.categories = [];
                this.logs = [];
                
                this.setupEventListeners();
                this.setupAuth();
                this.loadCategories();
                this.setupDateInputs();
                
                this.log('üí∞ „ÅäÈáëÁÆ°ÁêÜ„Ç¢„Éó„É™„ÇØ„É©„Ç§„Ç¢„É≥„ÉàÂàùÊúüÂåñÂÆå‰∫Ü');
            }

            // „É≠„Ç∞Ë®òÈå≤
            log(message) {
                const timestamp = new Date().toLocaleTimeString('ja-JP');
                const logEntry = `[${timestamp}] ${message}`;
                this.logs.push(logEntry);
                
                const debugLogs = document.getElementById('debugLogs');
                if (debugLogs) {
                    debugLogs.textContent = this.logs.slice(-20).join('\\n');
                    debugLogs.scrollTop = debugLogs.scrollHeight;
                }
                console.log(logEntry);
            }

            // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºË®≠ÂÆö
            setupEventListeners() {
                // ÂèñÂºï„Éï„Ç©„Éº„É†
                document.getElementById('transactionForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addTransaction();
                });

                // „Çø„Ç§„ÉóÂ§âÊõ¥ÊôÇ„Å´„Ç´„ÉÜ„Ç¥„É™Êõ¥Êñ∞
                document.getElementById('transactionType').addEventListener('change', () => {
                    this.updateCategoryOptions();
                });

                // Ë™çË®º„Éú„Çø„É≥
                document.getElementById('authBtn').addEventListener('click', () => {
                    this.toggleAuth();
                });
            }

            // Ë™çË®ºË®≠ÂÆö
            setupAuth() {
                auth.onAuthStateChanged((user) => {
                    this.currentUser = user;
                    this.updateAuthUI();
                    
                    if (user) {
                        this.log(`üë§ „É≠„Ç∞„Ç§„É≥ÊàêÂäü | ${user.email}`);
                        this.loadTransactions();
                    } else {
                        this.log('üë§ „É≠„Ç∞„Ç¢„Ç¶„Éà');
                    }
                });
            }

            // Ë™çË®ºUIÊõ¥Êñ∞
            updateAuthUI() {
                const authBtn = document.getElementById('authBtn');
                const userInfo = document.getElementById('userInfo');
                
                if (this.currentUser) {
                    authBtn.textContent = '„É≠„Ç∞„Ç¢„Ç¶„Éà';
                    userInfo.innerHTML = `
                        <span>üë§ ${this.currentUser.displayName || this.currentUser.email}</span>
                        <button class="auth-btn" id="authBtn">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
                    `;
                } else {
                    authBtn.textContent = 'Google„Åß„É≠„Ç∞„Ç§„É≥';
                    userInfo.innerHTML = '<button class="auth-btn" id="authBtn">Google„Åß„É≠„Ç∞„Ç§„É≥</button>';
                }
                
                // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÂÜçË®≠ÂÆö
                document.getElementById('authBtn').addEventListener('click', () => {
                    this.toggleAuth();
                });
            }

            // Ë™çË®ºÂàá„ÇäÊõø„Åà
            async toggleAuth() {
                try {
                    if (this.currentUser) {
                        await auth.signOut();
                    } else {
                        const provider = new firebase.auth.GoogleAuthProvider();
                        await auth.signInWithPopup(provider);
                    }
                } catch (error) {
                    this.log(`‚ùå Ë™çË®º„Ç®„É©„Éº | ${error.message}`);
                }
            }

            // „Ç´„ÉÜ„Ç¥„É™Ë™≠„ÅøËæº„Åø
            async loadCategories() {
                try {
                    const response = await fetch('/api/money/categories');
                    const data = await response.json();
                    this.categories = data.categories;
                    this.updateCategoryOptions();
                } catch (error) {
                    this.log(`‚ùå „Ç´„ÉÜ„Ç¥„É™Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº | ${error.message}`);
                }
            }

            // „Ç´„ÉÜ„Ç¥„É™„Ç™„Éó„Ç∑„Éß„É≥Êõ¥Êñ∞
            updateCategoryOptions() {
                const categorySelect = document.getElementById('transactionCategory');
                const type = document.getElementById('transactionType').value;
                
                categorySelect.innerHTML = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
                
                // „Çø„Ç§„Éó„Å´Âøú„Åò„Å¶„Ç´„ÉÜ„Ç¥„É™„Çí„Éï„Ç£„É´„Çø„Éº
                let filteredCategories = this.categories;
                if (type === 'income') {
                    filteredCategories = this.categories.filter(cat => 
                        cat.includes('Áµ¶‰∏é') || cat.includes('ÂâØÊ•≠') || cat.includes('„Éú„Éº„Éä„Çπ') || cat.includes('„Åù„ÅÆ‰ªñÂèéÂÖ•')
                    );
                } else if (type === 'expense') {
                    filteredCategories = this.categories.filter(cat => 
                        !cat.includes('Áµ¶‰∏é') && !cat.includes('ÂâØÊ•≠') && !cat.includes('„Éú„Éº„Éä„Çπ') && !cat.includes('„Åù„ÅÆ‰ªñÂèéÂÖ•')
                    );
                }
                
                filteredCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
            }

            // Êó•‰ªòÂÖ•ÂäõË®≠ÂÆö
            setupDateInputs() {
                const today = new Date().toISOString().slice(0, 10);
                document.getElementById('transactionDate').value = today;
                
                // Âπ¥ÊúàÈÅ∏Êäû„ÅÆË®≠ÂÆö
                const currentYear = new Date().getFullYear();
                const yearSelect = document.getElementById('reportYear');
                const monthSelect = document.getElementById('reportMonth');
                
                for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year + 'Âπ¥';
                    if (year === currentYear) option.selected = true;
                    yearSelect.appendChild(option);
                }
                
                for (let month = 1; month <= 12; month++) {
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = month + 'Êúà';
                    if (month === new Date().getMonth() + 1) option.selected = true;
                    monthSelect.appendChild(option);
                }
            }

            // ÂèñÂºïËøΩÂä†
            async addTransaction() {
                try {
                    const formData = {
                        type: document.getElementById('transactionType').value,
                        amount: parseFloat(document.getElementById('transactionAmount').value),
                        category: document.getElementById('transactionCategory').value,
                        description: document.getElementById('transactionDescription').value,
                        date: document.getElementById('transactionDate').value
                    };

                    const response = await fetch('/api/money/transaction', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        this.log(`‚úÖ ÂèñÂºïËøΩÂä†ÊàêÂäü | ¬•${formData.amount.toLocaleString()}`);
                        document.getElementById('transactionForm').reset();
                        this.setupDateInputs(); // Êó•‰ªò„Çí„É™„Çª„ÉÉ„Éà
                        this.loadTransactions();
                    } else {
                        throw new Error(data.error || 'ÂèñÂºïËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                } catch (error) {
                    this.log(`‚ùå ÂèñÂºïËøΩÂä†„Ç®„É©„Éº | ${error.message}`);
                }
            }

            // ÂèñÂºï‰∏ÄË¶ßË™≠„ÅøËæº„Åø
            async loadTransactions() {
                try {
                    const params = new URLSearchParams();
                    const startDate = document.getElementById('filterStartDate').value;
                    const endDate = document.getElementById('filterEndDate').value;
                    const type = document.getElementById('filterType').value;
                    
                    if (startDate) params.append('startDate', startDate);
                    if (endDate) params.append('endDate', endDate);
                    if (type) params.append('type', type);

                    const response = await fetch(`/api/money/transactions?${params}`);
                    const data = await response.json();
                    
                    this.transactions = data.transactions;
                    this.updateTransactionList();
                    this.updateStats(data.stats);
                    
                    this.log(`üìä ÂèñÂºï„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü | ${this.transactions.length}‰ª∂`);
                } catch (error) {
                    this.log(`‚ùå ÂèñÂºïË™≠„ÅøËæº„Åø„Ç®„É©„Éº | ${error.message}`);
                }
            }

            // ÂèñÂºï„É™„Çπ„ÉàÊõ¥Êñ∞
            updateTransactionList() {
                const container = document.getElementById('transactionList');
                
                if (this.transactions.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">ÂèñÂºï„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
                    return;
                }

                container.innerHTML = this.transactions.map(transaction => `
                    <div class="transaction-item transaction-${transaction.type}">
                        <div class="transaction-info">
                            <div class="transaction-amount amount-${transaction.type}">
                                ${transaction.type === 'income' ? '+' : '-'}¬•${transaction.amount.toLocaleString()}
                            </div>
                            <div class="transaction-meta">
                                ${transaction.category} | ${transaction.date} | ${transaction.description}
                            </div>
                        </div>
                        <button class="btn btn-danger" onclick="app.deleteTransaction('${transaction.id}')">ÂâäÈô§</button>
                    </div>
                `).join('');
            }

            // Áµ±Ë®àÊÉÖÂ†±Êõ¥Êñ∞
            updateStats(stats) {
                document.getElementById('totalIncome').textContent = `¬•${stats.totalIncome.toLocaleString()}`;
                document.getElementById('totalExpense').textContent = `¬•${stats.totalExpenses.toLocaleString()}`;
                document.getElementById('balance').textContent = `¬•${stats.balance.toLocaleString()}`;
                document.getElementById('transactionCount').textContent = stats.transactionCount;
                
                // ÊÆãÈ´ò„ÅÆËâ≤„ÇíË®≠ÂÆö
                const balanceElement = document.getElementById('balance');
                if (stats.balance > 0) {
                    balanceElement.className = 'stat-value amount-income';
                } else if (stats.balance < 0) {
                    balanceElement.className = 'stat-value amount-expense';
                } else {
                    balanceElement.className = 'stat-value';
                }
            }

            // ÂèñÂºïÂâäÈô§
            async deleteTransaction(id) {
                if (!confirm('„Åì„ÅÆÂèñÂºï„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
                
                try {
                    const response = await fetch(`/api/money/transaction/${id}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        this.log(`üóëÔ∏è ÂèñÂºïÂâäÈô§ÊàêÂäü | ID: ${id}`);
                        this.loadTransactions();
                    } else {
                        throw new Error(data.error || 'ÂèñÂºïÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                } catch (error) {
                    this.log(`‚ùå ÂèñÂºïÂâäÈô§„Ç®„É©„Éº | ${error.message}`);
                }
            }

            // „Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®
            applyFilters() {
                this.log('üîç „Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®');
                this.loadTransactions();
            }

            // CSVÂá∫Âäõ
            async exportCSV() {
                try {
                    const startDate = document.getElementById('filterStartDate').value;
                    const endDate = document.getElementById('filterEndDate').value;
                    const type = document.getElementById('filterType').value;

                    const response = await fetch('/api/money/export/csv', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ startDate, endDate, type })
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `money_transactions_${new Date().toISOString().slice(0,10)}.csv`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        
                        this.log('üìä CSVÂá∫ÂäõÂÆå‰∫Ü');
                    } else {
                        throw new Error('CSVÂá∫Âäõ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                } catch (error) {
                    this.log(`‚ùå CSVÂá∫Âäõ„Ç®„É©„Éº | ${error.message}`);
                }
            }

            // ÊúàÊ¨°„É¨„Éù„Éº„ÉàÁîüÊàê
            async generateMonthlyReport() {
                try {
                    const year = document.getElementById('reportYear').value;
                    const month = document.getElementById('reportMonth').value;

                    const response = await fetch(`/api/money/monthly-report?year=${year}&month=${month}`);
                    const report = await response.json();
                    
                    this.displayMonthlyReport(report);
                    this.log(`üìÖ ÊúàÊ¨°„É¨„Éù„Éº„ÉàÁîüÊàêÂÆå‰∫Ü | ${year}Âπ¥${month}Êúà`);
                } catch (error) {
                    this.log(`‚ùå ÊúàÊ¨°„É¨„Éù„Éº„ÉàÁîüÊàê„Ç®„É©„Éº | ${error.message}`);
                }
            }

            // ÊúàÊ¨°„É¨„Éù„Éº„ÉàË°®Á§∫
            displayMonthlyReport(report) {
                const container = document.getElementById('monthlyReportContent');
                const stats = report.summary;
                
                container.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value amount-income">¬•${stats.totalIncome.toLocaleString()}</div>
                            <div class="stat-label">ÂèéÂÖ•</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value amount-expense">¬•${stats.totalExpenses.toLocaleString()}</div>
                            <div class="stat-label">ÊîØÂá∫</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value ${stats.balance >= 0 ? 'amount-income' : 'amount-expense'}">¬•${stats.balance.toLocaleString()}</div>
                            <div class="stat-label">Â∑ÆÈ°ç</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.transactionCount}</div>
                            <div class="stat-label">ÂèñÂºïÊï∞</div>
                        </div>
                    </div>
                    <p style="margin-top: 15px; color: #666; font-size: 0.9rem;">
                        ÊúüÈñì: ${report.period} | ÁîüÊàêÊó•ÊôÇ: ${new Date(report.generatedAt).toLocaleString('ja-JP')}
                    </p>
                `;
            }

            // „Çµ„É≥„Éó„É´„Éá„Éº„ÇøÁîüÊàê
            async generateSampleData() {
                try {
                    const response = await fetch('/api/money/sample-data', {
                        method: 'POST'
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        this.log('üéØ „Çµ„É≥„Éó„É´„Éá„Éº„ÇøÁîüÊàêÂÆå‰∫Ü');
                        this.loadTransactions();
                    } else {
                        throw new Error(data.error || '„Çµ„É≥„Éó„É´„Éá„Éº„ÇøÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                } catch (error) {
                    this.log(`‚ùå „Çµ„É≥„Éó„É´„Éá„Éº„ÇøÁîüÊàê„Ç®„É©„Éº | ${error.message}`);
                }
            }

            // „É≠„Ç∞„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
            async downloadLogs() {
                try {
                    const response = await fetch('/api/generate-log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ source: 'money-app-client', logs: this.logs })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        this.log(`üìÑ „É≠„Ç∞„Éï„Ç°„Ç§„É´ÁîüÊàêÂÆå‰∫Ü | ${data.filename}`);
                    } else {
                        throw new Error(data.error || '„É≠„Ç∞„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                } catch (error) {
                    this.log(`‚ùå „É≠„Ç∞„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Ç®„É©„Éº | ${error.message}`);
                }
            }

            // „É≠„Ç∞„ÇØ„É™„Ç¢
            clearLogs() {
                this.logs = [];
                document.getElementById('debugLogs').textContent = '„É≠„Ç∞„Åå„ÇØ„É™„Ç¢„Åï„Çå„Åæ„Åó„Åü';
                this.log('üóëÔ∏è „É≠„Ç∞„Çí„ÇØ„É™„Ç¢„Åó„Åæ„Åó„Åü');
            }

            // API „ÉÜ„Çπ„Éà
            async testAPI() {
                try {
                    this.log('üîó APIÊé•Á∂ö„ÉÜ„Çπ„ÉàÈñãÂßã');
                    
                    const response = await fetch('/api/health');
                    const data = await response.json();
                    
                    if (data.status === 'OK') {
                        this.log('‚úÖ APIÊé•Á∂ö„ÉÜ„Çπ„ÉàÊàêÂäü');
                    } else {
                        this.log('‚ùå APIÊé•Á∂ö„ÉÜ„Çπ„ÉàÂ§±Êïó');
                    }
                } catch (error) {
                    this.log(`‚ùå APIÊé•Á∂ö„ÉÜ„Çπ„Éà„Ç®„É©„Éº | ${error.message}`);
                }
            }
        }

        // „Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞
        let app;
        
        window.addEventListener('load', () => {
            app = new MoneyAppClient();
        });
        
        function loadTransactions() { app.loadTransactions(); }
        function applyFilters() { app.applyFilters(); }
        function exportCSV() { app.exportCSV(); }
        function generateSampleData() { app.generateSampleData(); }
        function generateMonthlyReport() { app.generateMonthlyReport(); }
        function downloadLogs() { app.downloadLogs(); }
        function clearLogs() { app.clearLogs(); }
        function testAPI() { app.testAPI(); }
    </script>
</body>
</html>