<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’° ãŠé‡‘ç®¡ç†ã‚¢ãƒ—ãƒª - Firebase & Node.js</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        :root {
            --primary: #2E8B57;
            --success: #4CAF50;
            --danger: #f44336;
            --warning: #FF9800;
            --info: #2196F3;
            --bg: #f8f9fa;
            --surface: #fff;
            --text: #333;
            --border: #ddd;
            --shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            background: var(--surface);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        h1 {
            color: var(--primary);
            font-size: 1.8rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .auth-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .auth-btn:hover {
            opacity: 0.9;
        }

        /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .app-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .section {
            background: var(--surface);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }

        .section h3 {
            margin-bottom: 15px;
            color: var(--primary);
            border-bottom: 2px solid var(--primary);
            padding-bottom: 5px;
        }

        /* ãƒ•ã‚©ãƒ¼ãƒ  */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            height: 80px;
        }

        .form-row {
            display: flex;
            gap: 10px;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* ãƒœã‚¿ãƒ³ */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .btn-danger {
            background: var(--danger);
        }

        .btn-success {
            background: var(--success);
        }

        .btn-info {
            background: var(--info);
        }

        .btn-warning {
            background: var(--warning);
        }

        /* å–å¼•ãƒªã‚¹ãƒˆ */
        .transaction-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 8px;
            background: var(--surface);
        }

        .transaction-income {
            border-left: 4px solid var(--success);
        }

        .transaction-expense {
            border-left: 4px solid var(--danger);
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-amount {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .amount-income {
            color: var(--success);
        }

        .amount-expense {
            color: var(--danger);
        }

        .transaction-meta {
            font-size: 0.9rem;
            color: #666;
        }

        /* çµ±è¨ˆæƒ…å ± */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-card {
            background: var(--bg);
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        /* ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
        .filter-section {
            background: var(--bg);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        /* ãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        .log-section {
            grid-column: 1 / -1;
        }

        .log-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .debug-logs {
            background: #1e1e1e;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-line;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .app-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            header {
                flex-direction: column;
                gap: 15px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header>
            <h1>ğŸ’° ãŠé‡‘ç®¡ç†ã‚¢ãƒ—ãƒª</h1>
            <div class="user-info" id="userInfo">
                <button class="auth-btn" id="authBtn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
            </div>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <div class="app-grid">
            <!-- å–å¼•è¿½åŠ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h3>ğŸ’³ å–å¼•è¿½åŠ </h3>
                <form id="transactionForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transactionType">ã‚¿ã‚¤ãƒ—</label>
                            <select id="transactionType" required>
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="income">åå…¥</option>
                                <option value="expense">æ”¯å‡º</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="transactionAmount">é‡‘é¡</label>
                            <input type="number" id="transactionAmount" placeholder="0" min="0" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transactionCategory">ã‚«ãƒ†ã‚´ãƒª</label>
                            <select id="transactionCategory" required>
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="transactionDate">æ—¥ä»˜</label>
                            <input type="date" id="transactionDate" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="transactionDescription">è©³ç´°</label>
                        <textarea id="transactionDescription" placeholder="å–å¼•ã®è©³ç´°ã‚’å…¥åŠ›"></textarea>
                    </div>
                    
                    <button type="submit" class="btn">å–å¼•ã‚’è¿½åŠ </button>
                    <button type="button" class="btn btn-warning" onclick="generateSampleData()">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ</button>
                </form>
            </div>

            <!-- çµ±è¨ˆæƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h3>ğŸ“Š çµ±è¨ˆæƒ…å ±</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value amount-income" id="totalIncome">Â¥0</div>
                        <div class="stat-label">ç·åå…¥</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value amount-expense" id="totalExpense">Â¥0</div>
                        <div class="stat-label">ç·æ”¯å‡º</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="balance">Â¥0</div>
                        <div class="stat-label">æ®‹é«˜</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="transactionCount">0</div>
                        <div class="stat-label">å–å¼•æ•°</div>
                    </div>
                </div>
                
                <div class="log-controls">
                    <button class="btn btn-success" onclick="exportCSV()">ğŸ“Š CSVå‡ºåŠ›</button>
                    <button class="btn btn-info" onclick="loadTransactions()">ğŸ”„ æ›´æ–°</button>
                    <button class="btn btn-warning" onclick="downloadLogs()">ğŸ“¥ ãƒ­ã‚°DL</button>
                </div>
            </div>

            <!-- å–å¼•å±¥æ­´ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h3>ğŸ“‹ å–å¼•å±¥æ­´</h3>
                
                <div class="filter-section">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="filterStartDate">é–‹å§‹æ—¥</label>
                            <input type="date" id="filterStartDate">
                        </div>
                        <div class="form-group">
                            <label for="filterEndDate">çµ‚äº†æ—¥</label>
                            <input type="date" id="filterEndDate">
                        </div>
                        <div class="form-group">
                            <label for="filterType">ã‚¿ã‚¤ãƒ—</label>
                            <select id="filterType">
                                <option value="">ã™ã¹ã¦</option>
                                <option value="income">åå…¥</option>
                                <option value="expense">æ”¯å‡º</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-info" onclick="applyFilters()">ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨</button>
                </div>
                
                <div class="transaction-list" id="transactionList">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        å–å¼•ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                    </div>
                </div>
            </div>

            <!-- æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section">
                <h3>ğŸ“… æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</h3>
                
                <div class="form-row" style="margin-bottom: 15px;">
                    <div class="form-group">
                        <label for="reportYear">å¹´</label>
                        <select id="reportYear"></select>
                    </div>
                    <div class="form-group">
                        <label for="reportMonth">æœˆ</label>
                        <select id="reportMonth"></select>
                    </div>
                    <div class="form-group">
                        <button class="btn" onclick="generateMonthlyReport()" style="margin-top: 25px;">ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
                    </div>
                </div>
                
                <div id="monthlyReportContent">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„
                    </div>
                </div>
            </div>

            <!-- ãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="section log-section">
                <h3>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</h3>
                <div class="log-controls">
                    <button class="btn" onclick="downloadLogs()">ğŸ“¥ ãƒ­ã‚°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                    <button class="btn" onclick="clearLogs()">ğŸ—‘ï¸ ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
                    <button class="btn" onclick="testAPI()">ğŸ”— API ãƒ†ã‚¹ãƒˆ</button>
                </div>
                <div class="debug-logs" id="debugLogs">ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...</div>
            </div>
        </div>
    </div>

    <script>
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyA5PXKChizYDCXF_GJ4KL6Ylq9K5hCPXWE",
            authDomain: "shares-b1b97.firebaseapp.com",
            databaseURL: "https://shares-b1b97-default-rtdb.firebaseio.com",
            projectId: "shares-b1b97",
            storageBucket: "shares-b1b97.appspot.com",
            messagingSenderId: "927474832426",
            appId: "1:927474832426:web:8a8d8d8d8d8d8d8d8d8d8d"
        };

        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // ãŠé‡‘ç®¡ç†ã‚¢ãƒ—ãƒªã‚¯ãƒ©ã‚¹
        class MoneyAppClient {
            constructor() {
                this.currentUser = null;
                this.transactions = [];
                this.categories = [];
                this.logs = [];
                
                this.setupEventListeners();
                this.setupAuth();
                this.loadCategories();
                this.setupDateInputs();
                
                this.log('ğŸ’° ãŠé‡‘ç®¡ç†ã‚¢ãƒ—ãƒªã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆåˆæœŸåŒ–å®Œäº†');
            }

            // ãƒ­ã‚°è¨˜éŒ²
            log(message) {
                const timestamp = new Date().toLocaleTimeString('ja-JP');
                const logEntry = `[${timestamp}] ${message}`;
                this.logs.push(logEntry);
                
                const debugLogs = document.getElementById('debugLogs');
                if (debugLogs) {
                    debugLogs.textContent = this.logs.slice(-20).join('\\n');
                    debugLogs.scrollTop = debugLogs.scrollHeight;
                }
                console.log(logEntry);
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
            setupEventListeners() {
                // å–å¼•ãƒ•ã‚©ãƒ¼ãƒ 
                document.getElementById('transactionForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.addTransaction();
                });

                // ã‚¿ã‚¤ãƒ—å¤‰æ›´æ™‚ã«ã‚«ãƒ†ã‚´ãƒªæ›´æ–°
                document.getElementById('transactionType').addEventListener('change', () => {
                    this.updateCategoryOptions();
                });

                // èªè¨¼ãƒœã‚¿ãƒ³
                document.getElementById('authBtn').addEventListener('click', () => {
                    this.toggleAuth();
                });
            }

            // èªè¨¼è¨­å®š
            setupAuth() {
                auth.onAuthStateChanged((user) => {
                    this.currentUser = user;
                    this.updateAuthUI();
                    
                    if (user) {
                        this.log(`ğŸ‘¤ ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ | ${user.email}`);
                        this.loadTransactions();
                    } else {
                        this.log('ğŸ‘¤ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ');
                    }
                });
            }

            // èªè¨¼UIæ›´æ–°
            updateAuthUI() {
                const authBtn = document.getElementById('authBtn');
                const userInfo = document.getElementById('userInfo');
                
                if (this.currentUser) {
                    authBtn.textContent = 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ';
                    userInfo.innerHTML = `
                        <span>ğŸ‘¤ ${this.currentUser.displayName || this.currentUser.email}</span>
                        <button class="auth-btn" id="authBtn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                    `;
                } else {
                    authBtn.textContent = 'Googleã§ãƒ­ã‚°ã‚¤ãƒ³';
                    userInfo.innerHTML = '<button class="auth-btn" id="authBtn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>';
                }
                
                // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼å†è¨­å®š
                document.getElementById('authBtn').addEventListener('click', () => {
                    this.toggleAuth();
                });
            }

            // èªè¨¼åˆ‡ã‚Šæ›¿ãˆ
            async toggleAuth() {
                try {
                    if (this.currentUser) {
                        await auth.signOut();
                    } else {
                        const provider = new firebase.auth.GoogleAuthProvider();
                        await auth.signInWithPopup(provider);
                    }
                } catch (error) {
                    this.log(`âŒ èªè¨¼ã‚¨ãƒ©ãƒ¼ | ${error.message}`);
                }
            }

            // ã‚«ãƒ†ã‚´ãƒªèª­ã¿è¾¼ã¿
            async loadCategories() {
                try {
                    const response = await fetch('/api/money/categories');
                    const data = await response.json();
                    this.categories = data.categories;
                    this.updateCategoryOptions();
                } catch (error) {
                    this.log(`âŒ ã‚«ãƒ†ã‚´ãƒªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ | ${error.message}`);
                }
            }

            // ã‚«ãƒ†ã‚´ãƒªã‚ªãƒ—ã‚·ãƒ§ãƒ³æ›´æ–°
            updateCategoryOptions() {
                const categorySelect = document.getElementById('transactionCategory');
                const type = document.getElementById('transactionType').value;
                
                categorySelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
                
                // ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ã‚«ãƒ†ã‚´ãƒªã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
                let filteredCategories = this.categories;
                if (type === 'income') {
                    filteredCategories = this.categories.filter(cat => 
                        cat.includes('çµ¦ä¸') || cat.includes('å‰¯æ¥­') || cat.includes('ãƒœãƒ¼ãƒŠã‚¹') || cat.includes('ãã®ä»–åå…¥')
                    );
                } else if (type === 'expense') {
                    filteredCategories = this.categories.filter(cat => 
                        !cat.includes('çµ¦ä¸') && !cat.includes('å‰¯æ¥­') && !cat.includes('ãƒœãƒ¼ãƒŠã‚¹') && !cat.includes('ãã®ä»–åå…¥')
                    );
                }
                
                filteredCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
            }

            // æ—¥ä»˜å…¥åŠ›è¨­å®š
            setupDateInputs() {
                const today = new Date().toISOString().slice(0, 10);
                document.getElementById('transactionDate').value = today;
                
                // å¹´æœˆé¸æŠã®è¨­å®š
                const currentYear = new Date().getFullYear();
                const yearSelect = document.getElementById('reportYear');
                const monthSelect = document.getElementById('reportMonth');
                
                for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year + 'å¹´';
                    if (year === currentYear) option.selected = true;
                    yearSelect.appendChild(option);
                }
                
                for (let month = 1; month <= 12; month++) {
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = month + 'æœˆ';
                    if (month === new Date().getMonth() + 1) option.selected = true;
                    monthSelect.appendChild(option);
                }
            }

            // å–å¼•è¿½åŠ 
            async addTransaction() {
                try {
                    const formData = {
                        type: document.getElementById('transactionType').value,
                        amount: parseFloat(document.getElementById('transactionAmount').value),
                        category: document.getElementById('transactionCategory').value,
                        description: document.getElementById('transactionDescription').value,
                        date: document.getElementById('transactionDate').value
                    };

                    const response = await fetch('/api/money/transaction', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        this.log(`âœ… å–å¼•è¿½åŠ æˆåŠŸ | Â¥${formData.amount.toLocaleString()}`);
                        document.getElementById('transactionForm').reset();
                        this.setupDateInputs(); // æ—¥ä»˜ã‚’ãƒªã‚»ãƒƒãƒˆ
                        this.loadTransactions();
                    } else {
                        throw new Error(data.error || 'å–å¼•è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } catch (error) {
                    this.log(`âŒ å–å¼•è¿½åŠ ã‚¨ãƒ©ãƒ¼ | ${error.message}`);
                }
            }

            // å–å¼•ä¸€è¦§èª­ã¿è¾¼ã¿
            async loadTransactions() {
                try {
                    const params = new URLSearchParams();
                    const startDate = document.getElementById('filterStartDate').value;
                    const endDate = document.getElementById('filterEndDate').value;
                    const type = document.getElementById('filterType').value;
                    
                    if (startDate) params.append('startDate', startDate);
                    if (endDate) params.append('endDate', endDate);
                    if (type) params.append('type', type);

                    const response = await fetch(`/api/money/transactions?${params}`);
                    const data = await response.json();
                    
                    this.transactions = data.transactions;
                    this.updateTransactionList();
                    this.updateStats(data.stats);
                    
                    this.log(`ğŸ“Š å–å¼•ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº† | ${this.transactions.length}ä»¶`);
                } catch (error) {
                    this.log(`âŒ å–å¼•èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ | ${error.message}`);
                }
            }

            // å–å¼•ãƒªã‚¹ãƒˆæ›´æ–°
            updateTransactionList() {
                const container = document.getElementById('transactionList');
                
                if (this.transactions.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">å–å¼•ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                    return;
                }

                container.innerHTML = this.transactions.map(transaction => `
                    <div class="transaction-item transaction-${transaction.type}">
                        <div class="transaction-info">
                            <div class="transaction-amount amount-${transaction.type}">
                                ${transaction.type === 'income' ? '+' : '-'}Â¥${transaction.amount.toLocaleString()}
                            </div>
                            <div class="transaction-meta">
                                ${transaction.category} | ${transaction.date} | ${transaction.description}
                            </div>
                        </div>
                        <button class="btn btn-danger" onclick="app.deleteTransaction('${transaction.id}')">å‰Šé™¤</button>
                    </div>
                `).join('');
            }

            // çµ±è¨ˆæƒ…å ±æ›´æ–°
            updateStats(stats) {
                document.getElementById('totalIncome').textContent = `Â¥${stats.totalIncome.toLocaleString()}`;
                document.getElementById('totalExpense').textContent = `Â¥${stats.totalExpenses.toLocaleString()}`;
                document.getElementById('balance').textContent = `Â¥${stats.balance.toLocaleString()}`;
                document.getElementById('transactionCount').textContent = stats.transactionCount;
                
                // æ®‹é«˜ã®è‰²ã‚’è¨­å®š
                const balanceElement = document.getElementById('balance');
                if (stats.balance > 0) {
                    balanceElement.className = 'stat-value amount-income';
                } else if (stats.balance < 0) {
                    balanceElement.className = 'stat-value amount-expense';
                } else {
                    balanceElement.className = 'stat-value';
                }
            }

            // å–å¼•å‰Šé™¤
            async deleteTransaction(id) {
                if (!confirm('ã“ã®å–å¼•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
                
                try {
                    const response = await fetch(`/api/money/transaction/${id}`, {
                        method: 'DELETE'
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        this.log(`ğŸ—‘ï¸ å–å¼•å‰Šé™¤æˆåŠŸ | ID: ${id}`);
                        this.loadTransactions();
                    } else {
                        throw new Error(data.error || 'å–å¼•å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } catch (error) {
                    this.log(`âŒ å–å¼•å‰Šé™¤ã‚¨ãƒ©ãƒ¼ | ${error.message}`);
                }
            }

            // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
            applyFilters() {
                this.log('ğŸ” ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨');
                this.loadTransactions();
            }

            // CSVå‡ºåŠ›
            async exportCSV() {
                try {
                    const startDate = document.getElementById('filterStartDate').value;
                    const endDate = document.getElementById('filterEndDate').value;
                    const type = document.getElementById('filterType').value;

                    const response = await fetch('/api/money/export/csv', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ startDate, endDate, type })
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `money_transactions_${new Date().toISOString().slice(0,10)}.csv`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                        
                        this.log('ğŸ“Š CSVå‡ºåŠ›å®Œäº†');
                    } else {
                        throw new Error('CSVå‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } catch (error) {
                    this.log(`âŒ CSVå‡ºåŠ›ã‚¨ãƒ©ãƒ¼ | ${error.message}`);
                }
            }

            // æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
            async generateMonthlyReport() {
                try {
                    const year = document.getElementById('reportYear').value;
                    const month = document.getElementById('reportMonth').value;

                    const response = await fetch(`/api/money/monthly-report?year=${year}&month=${month}`);
                    const report = await response.json();
                    
                    this.displayMonthlyReport(report);
                    this.log(`ğŸ“… æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº† | ${year}å¹´${month}æœˆ`);
                } catch (error) {
                    this.log(`âŒ æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼ | ${error.message}`);
                }
            }

            // æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆè¡¨ç¤º
            displayMonthlyReport(report) {
                const container = document.getElementById('monthlyReportContent');
                const stats = report.summary;
                
                container.innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value amount-income">Â¥${stats.totalIncome.toLocaleString()}</div>
                            <div class="stat-label">åå…¥</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value amount-expense">Â¥${stats.totalExpenses.toLocaleString()}</div>
                            <div class="stat-label">æ”¯å‡º</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value ${stats.balance >= 0 ? 'amount-income' : 'amount-expense'}">Â¥${stats.balance.toLocaleString()}</div>
                            <div class="stat-label">å·®é¡</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${stats.transactionCount}</div>
                            <div class="stat-label">å–å¼•æ•°</div>
                        </div>
                    </div>
                    <p style="margin-top: 15px; color: #666; font-size: 0.9rem;">
                        æœŸé–“: ${report.period} | ç”Ÿæˆæ—¥æ™‚: ${new Date(report.generatedAt).toLocaleString('ja-JP')}
                    </p>
                `;
            }

            // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
            async generateSampleData() {
                try {
                    const response = await fetch('/api/money/sample-data', {
                        method: 'POST'
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        this.log('ğŸ¯ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†');
                        this.loadTransactions();
                    } else {
                        throw new Error(data.error || 'ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } catch (error) {
                    this.log(`âŒ ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚¨ãƒ©ãƒ¼ | ${error.message}`);
                }
            }

            // ãƒ­ã‚°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            async downloadLogs() {
                try {
                    const response = await fetch('/api/generate-log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ source: 'money-app-client', logs: this.logs })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        this.log(`ğŸ“„ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆå®Œäº† | ${data.filename}`);
                    } else {
                        throw new Error(data.error || 'ãƒ­ã‚°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                } catch (error) {
                    this.log(`âŒ ãƒ­ã‚°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼ | ${error.message}`);
                }
            }

            // ãƒ­ã‚°ã‚¯ãƒªã‚¢
            clearLogs() {
                this.logs = [];
                document.getElementById('debugLogs').textContent = 'ãƒ­ã‚°ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ';
                this.log('ğŸ—‘ï¸ ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            }

            // API ãƒ†ã‚¹ãƒˆ
            async testAPI() {
                try {
                    this.log('ğŸ”— APIæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹');
                    
                    const response = await fetch('/api/health');
                    const data = await response.json();
                    
                    if (data.status === 'OK') {
                        this.log('âœ… APIæ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ');
                    } else {
                        this.log('âŒ APIæ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—');
                    }
                } catch (error) {
                    this.log(`âŒ APIæ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ | ${error.message}`);
                }
            }
        }

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        let app;
        
        window.addEventListener('load', () => {
            app = new MoneyAppClient();
        });
        
        function loadTransactions() { app.loadTransactions(); }
        function applyFilters() { app.applyFilters(); }
        function exportCSV() { app.exportCSV(); }
        function generateSampleData() { app.generateSampleData(); }
        function generateMonthlyReport() { app.generateMonthlyReport(); }
        function downloadLogs() { app.downloadLogs(); }
        function clearLogs() { app.clearLogs(); }
        function testAPI() { app.testAPI(); }
    </script>
</body>
</html>