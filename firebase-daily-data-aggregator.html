<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Firebase DB æ¯æ—¥é›†è¨ˆã‚·ã‚¹ãƒ†ãƒ  - ãƒ‡ãƒ¼ã‚¿é•·ã¨ã‚µãƒãƒªãƒ¼ã®è‡ªå‹•é›†è¨ˆ">
    <title>ğŸ”¥ Firebase DB æ¯æ—¥é›†è¨ˆã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        :root {
            --primary: #4CAF50;
            --danger: #f44336;
            --info: #2196F3;
            --warning: #ff9800;
            --bg: #f5f5f5;
            --surface: #fff;
            --text: #333;
            --border: #ddd;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Googleèªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ */
        header {
            background: var(--surface);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        h1 {
            font-size: 24px;
            margin-bottom: 15px;
            text-align: center;
        }

        .user-info {
            text-align: center;
            margin-bottom: 15px;
        }

        .auth-btn {
            background: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        /* ãƒ‡ãƒ¼ã‚¿é›†è¨ˆãƒ‘ãƒãƒ« */
        .aggregation-panel {
            background: var(--surface);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .panel-title {
            font-size: 18px;
            font-weight: bold;
        }

        .date-picker {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .date-input {
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: transform 0.1s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        /* ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ */
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background: var(--surface);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .summary-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .summary-value {
            font-size: 24px;
            font-weight: bold;
        }

        .data-length { color: var(--primary); }
        .record-count { color: var(--info); }
        .avg-size { color: var(--warning); }
        .storage-usage { color: var(--danger); }

        /* ãƒ‡ãƒ¼ã‚¿è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« */
        .data-table {
            background: var(--surface);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 20px;
        }

        .table-header {
            background: #f8f9fa;
            padding: 15px;
            font-weight: bold;
            border-bottom: 1px solid var(--border);
        }

        .table-content {
            max-height: 400px;
            overflow-y: auto;
        }

        .table-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr 60px;
            padding: 10px 15px;
            border-bottom: 1px solid #f0f0f0;
            align-items: center;
        }

        .table-row:hover {
            background: #f9f9f9;
        }

        /* è‡ªå‹•é›†è¨ˆè¨­å®š */
        .auto-aggregation {
            background: #fff3cd;
            border: 2px solid var(--warning);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .switch {
            position: relative;
            width: 60px;
            height: 30px;
            background: #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .switch.active {
            background: var(--primary);
        }

        .switch-handle {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .switch.active .switch-handle {
            transform: translateX(30px);
        }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        .status-info {
            background: var(--surface);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background: var(--primary); }
        .status-offline { background: var(--danger); }
        .status-processing { background: var(--warning); }

        /* ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ  */
        .debug-log {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #222;
            color: #fff;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            display: none;
            z-index: 1000;
        }

        .debug-log.show {
            display: block;
        }

        .debug-header {
            background: #333;
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
        }

        .debug-content {
            padding: 10px;
        }

        .debug-btn {
            background: #555;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }

        .debug-btn:hover {
            background: #666;
        }

        .debug-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 1001;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 600px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .table-row {
                grid-template-columns: 1fr 1fr;
                grid-gap: 5px;
            }
            
            .panel-header {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Googleèªè¨¼ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header>
            <h1>ğŸ”¥ Firebase DB æ¯æ—¥é›†è¨ˆã‚·ã‚¹ãƒ†ãƒ </h1>
            <div class="user-info" id="userInfo">
                <button class="auth-btn" id="authBtn">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
            </div>
        </header>

        <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æƒ…å ± -->
        <div class="status-info" id="statusInfo">
            <span class="status-indicator status-offline" id="statusIndicator"></span>
            <span id="statusText">Firebaseæ¥ç¶šå¾…æ©Ÿä¸­...</span>
        </div>

        <!-- è‡ªå‹•é›†è¨ˆè¨­å®š -->
        <div class="auto-aggregation">
            <h3>ğŸ¤– è‡ªå‹•é›†è¨ˆè¨­å®š</h3>
            <div class="toggle-switch">
                <span>æ¯æ—¥è‡ªå‹•é›†è¨ˆ:</span>
                <div class="switch" id="autoSwitch" onclick="toggleAutoAggregation()">
                    <div class="switch-handle"></div>
                </div>
                <span id="autoStatus">OFF</span>
            </div>
            <p style="font-size: 12px; color: #666;">
                æœ‰åŠ¹ã«ã™ã‚‹ã¨æ¯æ—¥åˆå‰0æ™‚ã«ãƒ‡ãƒ¼ã‚¿é›†è¨ˆã‚’è‡ªå‹•å®Ÿè¡Œã—ã¾ã™
            </p>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿é›†è¨ˆãƒ‘ãƒãƒ« -->
        <div class="aggregation-panel">
            <div class="panel-header">
                <div class="panel-title">ğŸ“Š ãƒ‡ãƒ¼ã‚¿é›†è¨ˆ</div>
                <div class="date-picker">
                    <input type="date" id="targetDate" class="date-input">
                    <button class="btn btn-primary" onclick="aggregateData()">é›†è¨ˆå®Ÿè¡Œ</button>
                    <button class="btn btn-info" onclick="aggregateAllDates()">å…¨æœŸé–“é›†è¨ˆ</button>
                </div>
            </div>

            <!-- ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ -->
            <div class="summary-grid">
                <div class="summary-card">
                    <div class="summary-label">ç·ãƒ‡ãƒ¼ã‚¿é•·</div>
                    <div class="summary-value data-length" id="totalDataLength">0 KB</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°</div>
                    <div class="summary-value record-count" id="totalRecords">0 ä»¶</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">å¹³å‡ã‚µã‚¤ã‚º</div>
                    <div class="summary-value avg-size" id="avgSize">0 B</div>
                </div>
                <div class="summary-card">
                    <div class="summary-label">ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡</div>
                    <div class="summary-value storage-usage" id="storageUsage">0 %</div>
                </div>
            </div>
        </div>

        <!-- ãƒ‡ãƒ¼ã‚¿è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ« -->
        <div class="data-table">
            <div class="table-header">
                ğŸ“… æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿è©³ç´°
            </div>
            <div class="table-content" id="dataTableContent">
                <div style="padding: 20px; text-align: center; color: #666;">
                    ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆã—ã¦ãã ã•ã„
                </div>
            </div>
        </div>

        <!-- æ–°æ©Ÿèƒ½ãƒœã‚¿ãƒ³ -->
        <div class="aggregation-panel">
            <h3 style="margin-bottom: 15px;">ğŸ“Š ãƒ‡ãƒ¼ã‚¿æ“ä½œ</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                <button class="btn btn-primary" onclick="extractTodayInputData()">
                    ğŸ“… æœ¬æ—¥å…¥åŠ›ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
                </button>
                <button class="btn btn-info" onclick="uploadToGitHub()">
                    ğŸš€ GitHubã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                </button>
                <button class="btn btn-warning" onclick="checkFirebaseCost()">
                    ğŸ’° Firebaseæ–™é‡‘ãƒã‚§ãƒƒã‚¯
                </button>
                <button class="btn btn-primary" onclick="exportData()">
                    ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                </button>
            </div>
        </div>

        <!-- ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ -->
        <div class="aggregation-panel">
            <h3 style="margin-bottom: 15px;">ğŸ§ª ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button class="btn btn-info" onclick="testDataGeneration()">
                    ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
                </button>
                <button class="btn btn-warning" onclick="testAggregation()">
                    ğŸ“Š é›†è¨ˆãƒ†ã‚¹ãƒˆ
                </button>
            </div>
        </div>

        <!-- ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå°‚ç”¨ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ« -->
        <div class="aggregation-panel">
            <h3 style="margin-bottom: 15px;">ğŸ“± ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå°‚ç”¨ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                <button class="btn btn-info" onclick="showDebugInfo()">
                    ğŸ” ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±è¡¨ç¤º
                </button>
                <button class="btn btn-warning" onclick="testFirebaseConnection()">
                    ğŸ”¥ Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆ
                </button>
                <button class="btn btn-primary" onclick="showFullLog()">
                    ğŸ“‹ ãƒ•ãƒ«ãƒ­ã‚°è¡¨ç¤º
                </button>
                <button class="btn btn-info" onclick="exportDebugReport()">
                    ğŸ“Š ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
                </button>
            </div>
            <div id="tabletDebugOutput" style="background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; max-height: 200px; overflow-y: auto; display: none;">
                <div id="tabletDebugContent"></div>
            </div>
        </div>
    </div>

    <!-- ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ  -->
    <div class="debug-log" id="debugLog">
        <div class="debug-header">
            <span>ğŸ¤– Firebaseé›†è¨ˆã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°</span>
            <div>
                <button class="debug-btn" onclick="copyDebugLog()">ã‚³ãƒ”ãƒ¼</button>
                <button class="debug-btn" onclick="downloadDebugLog()">ğŸ“¥ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                <button class="debug-btn" onclick="clearDebugLog()">ã‚¯ãƒªã‚¢</button>
                <button class="debug-btn" onclick="toggleDebug()">é–‰ã˜ã‚‹</button>
            </div>
        </div>
        <div class="debug-content" id="debugContent"></div>
    </div>
    <button class="debug-toggle" onclick="toggleDebug()">ãƒ­ã‚°</button>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyA5PXKChizYDCXF_GJ4KL6Ylq9K5hCPXWE",
            authDomain: "shares-b1b97.firebaseapp.com",
            databaseURL: "https://shares-b1b97-default-rtdb.firebaseio.com",
            projectId: "shares-b1b97",
            storageBucket: "shares-b1b97.firebasestorage.app",
            messagingSenderId: "38311063248",
            appId: "1:38311063248:web:0d2d5726d12b305b24b8d5",
            measurementId: "G-S2ZMJH7CGC"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹
        class FirebaseDataAggregator {
            constructor() {
                this.currentUser = null;
                this.autoAggregationEnabled = false;
                this.aggregationData = {};
                this.autoAggregationInterval = null;
                
                this.init();
            }

            init() {
                this.log('=== ğŸ”¥ Firebase DBæ¯æ—¥é›†è¨ˆã‚·ã‚¹ãƒ†ãƒ  åˆæœŸåŒ–é–‹å§‹ ===');
                
                this.setupAuth();
                this.setupEventListeners();
                this.loadSettings();
                
                // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('targetDate').value = today;
                
                this.log('=== Firebase DBæ¯æ—¥é›†è¨ˆã‚·ã‚¹ãƒ†ãƒ  åˆæœŸåŒ–å®Œäº† ===');
            }

            log(message, data = null) {
                const time = new Date().toLocaleTimeString();
                const logMsg = `[${time}] ${message}`;
                console.log(logMsg, data || '');
                
                const debugContent = document.getElementById('debugContent');
                debugContent.innerHTML += `<div>${logMsg} ${data ? JSON.stringify(data) : ''}</div>`;
                debugContent.scrollTop = debugContent.scrollHeight;
            }

            setupAuth() {
                auth.onAuthStateChanged(user => {
                    this.currentUser = user;
                    this.updateUserUI();
                    this.updateStatus();
                    
                    if (user) {
                        this.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³å®Œäº†', {
                            email: user.email,
                            uid: user.uid
                        });
                        this.updateStatus('online', `Firebaseæ¥ç¶šå®Œäº† - ${user.email}`);
                    } else {
                        this.log('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ');
                        this.updateStatus('offline', 'Firebaseæ¥ç¶šå¾…æ©Ÿä¸­...');
                    }
                });
            }

            setupEventListeners() {
                // 30ç§’ã”ã¨ã«è‡ªå‹•é›†è¨ˆãƒã‚§ãƒƒã‚¯ï¼ˆè‡ªå‹•é›†è¨ˆãŒæœ‰åŠ¹ãªå ´åˆï¼‰
                setInterval(() => {
                    if (this.autoAggregationEnabled) {
                        this.checkAutoAggregation();
                    }
                }, 30000);
            }

            updateUserUI() {
                const userInfo = document.getElementById('userInfo');
                if (this.currentUser) {
                    userInfo.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span>${this.currentUser.displayName || this.currentUser.email}</span>
                            <button class="auth-btn" onclick="signOut()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                        </div>
                    `;
                } else {
                    userInfo.innerHTML = `
                        <button class="auth-btn" onclick="signIn()">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
                    `;
                }
            }

            updateStatus(status = 'offline', message = 'Firebaseæ¥ç¶šå¾…æ©Ÿä¸­...') {
                const indicator = document.getElementById('statusIndicator');
                const text = document.getElementById('statusText');
                
                indicator.className = `status-indicator status-${status}`;
                text.textContent = message;
            }

            // Firebase DBå…¨ä½“ã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
            async aggregateData(targetDate = null) {
                if (!this.currentUser) {
                    alert('Googleãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                    return;
                }

                const date = targetDate || document.getElementById('targetDate').value;
                if (!date) {
                    alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }

                this.log('=== ãƒ‡ãƒ¼ã‚¿é›†è¨ˆé–‹å§‹ ===', { targetDate: date });
                this.updateStatus('processing', 'ãƒ‡ãƒ¼ã‚¿é›†è¨ˆä¸­...');

                try {
                    // æ¨©é™ãƒ†ã‚¹ãƒˆ - ã¾ãšå°ã•ãªãƒ‘ã‚¹ã§æ¨©é™ç¢ºèª
                    this.log('Firebaseæ¨©é™ãƒ†ã‚¹ãƒˆé–‹å§‹...');
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ‘ã‚¹ã§ãƒ†ã‚¹ãƒˆ
                    const userTestRef = database.ref(`data-aggregation/${this.currentUser.uid}/test`);
                    await userTestRef.set({ test: true, timestamp: Date.now() });
                    this.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ‘ã‚¹æ¨©é™OK');
                    
                    // æ¨©é™ã‚¨ãƒ©ãƒ¼å¯¾ç­–: ãƒ«ãƒ¼ãƒˆã‚¢ã‚¯ã‚»ã‚¹ã®ä»£ã‚ã‚Šã«ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ¸ˆã¿ãƒ‘ã‚¹ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹
                    this.log('èªè¨¼æ¸ˆã¿ãƒ‘ã‚¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—é–‹å§‹...');
                    
                    // è¤‡æ•°ã®æ—¢çŸ¥ãƒ‘ã‚¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
                    const knownPaths = [
                        `webapp-template/${this.currentUser.uid}`,
                        `data-aggregation/${this.currentUser.uid}`,
                        `connection-test/${this.currentUser.uid}`,
                        `realtime-test/${this.currentUser.uid}`
                    ];
                    
                    let allData = {};
                    let accessiblePaths = [];
                    
                    for (const path of knownPaths) {
                        try {
                            const snapshot = await database.ref(path).once('value');
                            if (snapshot.exists()) {
                                allData[path] = snapshot.val();
                                accessiblePaths.push(path);
                                this.log(`âœ… ã‚¢ã‚¯ã‚»ã‚¹æˆåŠŸ: ${path}`, { hasData: true });
                            } else {
                                this.log(`ğŸ“ ãƒ‡ãƒ¼ã‚¿ãªã—: ${path}`, { hasData: false });
                            }
                        } catch (pathError) {
                            this.log(`âŒ ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯: ${path}`, pathError.message);
                        }
                    }
                    
                    this.log('ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãƒ‘ã‚¹', { accessiblePaths: accessiblePaths, totalPaths: knownPaths.length });
                    
                    // æŒ‡å®šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºãƒ»åˆ†æ
                    const dateAggregation = this.analyzeDataByDate(allData, date);
                    
                    // ã‚¢ã‚¯ã‚»ã‚¹æƒ…å ±ã‚’è¿½åŠ 
                    dateAggregation.accessInfo = {
                        accessiblePaths: accessiblePaths,
                        totalPathsChecked: knownPaths.length,
                        permissionNote: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æ¸ˆã¿ãƒ‘ã‚¹ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆæ¨©é™åˆ¶é™å¯¾å¿œï¼‰'
                    };
                    
                    // çµæœã‚’è¡¨ç¤º
                    this.displayAggregationResults(dateAggregation);
                    
                    // é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
                    await this.saveAggregationResults(date, dateAggregation);
                    
                    this.log('âœ… ãƒ‡ãƒ¼ã‚¿é›†è¨ˆå®Œäº†', dateAggregation);
                    this.updateStatus('online', `é›†è¨ˆå®Œäº† - ${dateAggregation.totalRecords}ä»¶ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã€${accessiblePaths.length}ãƒ‘ã‚¹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—`);
                    
                } catch (error) {
                    this.log('âŒ ãƒ‡ãƒ¼ã‚¿é›†è¨ˆã‚¨ãƒ©ãƒ¼', error.message);
                    
                    // è©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
                    const errorInfo = {
                        message: error.message,
                        code: error.code,
                        details: error.details,
                        suggestion: 'Firebase Database Rules ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚èª­ã¿å–ã‚Šæ¨©é™ãŒå¿…è¦ã§ã™ã€‚'
                    };
                    
                    this.log('ã‚¨ãƒ©ãƒ¼è©³ç´°', errorInfo);
                    this.updateStatus('offline', 'Firebaseæ¨©é™ã‚¨ãƒ©ãƒ¼: Database Rulesè¦ç¢ºèª');
                    
                    // Firebase Console URLã‚’è¡¨ç¤º
                    this.showFirebasePermissionHelp();
                }
            }

            // Firebaseæ¨©é™ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
            showFirebasePermissionHelp() {
                const helpMessage = `
ğŸ”¥ Firebaseæ¨©é™ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ

ã€è§£æ±ºæ–¹æ³•ã€‘
1. Firebase Console ã‚’é–‹ã
   https://console.firebase.google.com/

2. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã€Œshares-b1b97ã€ã‚’é¸æŠ

3. å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ŒRealtime Databaseã€â†’ã€Œãƒ«ãƒ¼ãƒ«ã€ã‚¿ãƒ–

4. ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒ«ã«å¤‰æ›´ï¼š
   {
     "rules": {
       ".read": "auth != null",
       ".write": "auth != null"
     }
   }

5. ã€Œå…¬é–‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

ç¾åœ¨ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™ã€‚
                `;
                
                alert(helpMessage);
                this.log('Firebaseæ¨©é™ãƒ˜ãƒ«ãƒ—è¡¨ç¤ºå®Œäº†');
            }

            // æ—¥ä»˜åˆ¥ãƒ‡ãƒ¼ã‚¿åˆ†æ
            analyzeDataByDate(allData, targetDate) {
                const analysis = {
                    date: targetDate,
                    totalDataLength: 0,
                    totalRecords: 0,
                    avgRecordSize: 0,
                    dataByApp: {},
                    dataByUser: {},
                    timestamp: Date.now()
                };

                // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’èµ°æŸ»ã—ã¦ã‚µã‚¤ã‚ºè¨ˆç®—
                const dataStr = JSON.stringify(allData);
                analysis.totalDataLength = new Blob([dataStr]).size;

                // ã‚¢ãƒ—ãƒªåˆ¥ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ãƒ»æ—¥ä»˜åˆ¥ã«åˆ†æ
                this.traverseData(allData, '', analysis, targetDate);

                // å¹³å‡ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚µã‚¤ã‚ºè¨ˆç®—
                if (analysis.totalRecords > 0) {
                    analysis.avgRecordSize = Math.round(analysis.totalDataLength / analysis.totalRecords);
                }

                return analysis;
            }

            // ãƒ‡ãƒ¼ã‚¿èµ°æŸ»ï¼ˆå†å¸°çš„ï¼‰
            traverseData(data, path, analysis, targetDate) {
                if (!data || typeof data !== 'object') return;

                for (const [key, value] of Object.entries(data)) {
                    const currentPath = path ? `${path}/${key}` : key;
                    
                    if (typeof value === 'object' && value !== null) {
                        // æ—¥ä»˜å½¢å¼ã®ã‚­ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆYYYY-MM-DDï¼‰
                        if (key.match(/^\d{4}-\d{2}-\d{2}$/) && key === targetDate) {
                            // æŒ‡å®šæ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’è©³ç´°åˆ†æ
                            this.analyzeTargetDateData(value, currentPath, analysis);
                        } else {
                            // å†å¸°çš„ã«èµ°æŸ»
                            this.traverseData(value, currentPath, analysis, targetDate);
                        }
                    }
                }
            }

            // æŒ‡å®šæ—¥ãƒ‡ãƒ¼ã‚¿ã®è©³ç´°åˆ†æ
            analyzeTargetDateData(dateData, path, analysis) {
                const dataStr = JSON.stringify(dateData);
                const dataSize = new Blob([dataStr]).size;
                
                // ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                const recordCount = this.countRecords(dateData);
                analysis.totalRecords += recordCount;

                // ã‚¢ãƒ—ãƒªåˆ¥é›†è¨ˆ
                const appName = path.split('/')[0] || 'unknown';
                if (!analysis.dataByApp[appName]) {
                    analysis.dataByApp[appName] = { size: 0, records: 0 };
                }
                analysis.dataByApp[appName].size += dataSize;
                analysis.dataByApp[appName].records += recordCount;

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥é›†è¨ˆï¼ˆãƒ‘ã‚¹ã«UIDãŒå«ã¾ã‚Œã‚‹å ´åˆï¼‰
                const pathParts = path.split('/');
                const userUid = pathParts.find(part => part.length === 28); // Firebase UIDã®é•·ã•
                if (userUid) {
                    if (!analysis.dataByUser[userUid]) {
                        analysis.dataByUser[userUid] = { size: 0, records: 0 };
                    }
                    analysis.dataByUser[userUid].size += dataSize;
                    analysis.dataByUser[userUid].records += recordCount;
                }

                this.log('æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿åˆ†æ', {
                    path: path,
                    size: dataSize,
                    records: recordCount,
                    app: appName
                });
            }

            // ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ã‚«ã‚¦ãƒ³ãƒˆ
            countRecords(data) {
                if (!data || typeof data !== 'object') return 0;
                
                let count = 0;
                for (const value of Object.values(data)) {
                    if (typeof value === 'object' && value !== null) {
                        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å ´åˆã¯å†å¸°çš„ã«ã‚«ã‚¦ãƒ³ãƒˆ
                        if (this.isRecord(value)) {
                            count++;
                        } else {
                            count += this.countRecords(value);
                        }
                    }
                }
                return count;
            }

            // ãƒ¬ã‚³ãƒ¼ãƒ‰ã‹ã©ã†ã‹åˆ¤å®šï¼ˆtimestampã‚„idãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹ã‹ï¼‰
            isRecord(obj) {
                return obj && typeof obj === 'object' && 
                       (obj.hasOwnProperty('timestamp') || obj.hasOwnProperty('id') || obj.hasOwnProperty('amount'));
            }

            // é›†è¨ˆçµæœè¡¨ç¤º
            displayAggregationResults(analysis) {
                // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰æ›´æ–°
                document.getElementById('totalDataLength').textContent = this.formatBytes(analysis.totalDataLength);
                document.getElementById('totalRecords').textContent = analysis.totalRecords.toLocaleString() + ' ä»¶';
                document.getElementById('avgSize').textContent = this.formatBytes(analysis.avgRecordSize);
                
                // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ï¼ˆFirebaseåˆ¶é™ã¨ã®æ¯”è¼ƒï¼‰
                const firebaseLimit = 1024 * 1024 * 1024; // 1GB (ç„¡æ–™ãƒ—ãƒ©ãƒ³ã®åˆ¶é™)
                const usagePercent = (analysis.totalDataLength / firebaseLimit * 100).toFixed(2);
                document.getElementById('storageUsage').textContent = usagePercent + ' %';

                // è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
                this.updateDataTable(analysis);
            }

            // ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
            updateDataTable(analysis) {
                const tableContent = document.getElementById('dataTableContent');
                let html = '';

                // ã‚¢ãƒ—ãƒªåˆ¥ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
                html += '<div style="padding: 15px; background: #f8f9fa; font-weight: bold;">ğŸ“± ã‚¢ãƒ—ãƒªåˆ¥ãƒ‡ãƒ¼ã‚¿</div>';
                for (const [appName, data] of Object.entries(analysis.dataByApp)) {
                    html += `
                        <div class="table-row">
                            <div>${appName}</div>
                            <div>${this.formatBytes(data.size)}</div>
                            <div>${data.records} ä»¶</div>
                            <div>${this.formatBytes(data.size / data.records || 0)}</div>
                            <div>ğŸ“Š</div>
                        </div>
                    `;
                }

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º
                if (Object.keys(analysis.dataByUser).length > 0) {
                    html += '<div style="padding: 15px; background: #f8f9fa; font-weight: bold;">ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ãƒ‡ãƒ¼ã‚¿</div>';
                    for (const [userUid, data] of Object.entries(analysis.dataByUser)) {
                        const displayUid = userUid.substring(0, 8) + '...';
                        html += `
                            <div class="table-row">
                                <div>${displayUid}</div>
                                <div>${this.formatBytes(data.size)}</div>
                                <div>${data.records} ä»¶</div>
                                <div>${this.formatBytes(data.size / data.records || 0)}</div>
                                <div>ğŸ‘¤</div>
                            </div>
                        `;
                    }
                }

                tableContent.innerHTML = html;
            }

            // ãƒã‚¤ãƒˆæ•°ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            formatBytes(bytes) {
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            // é›†è¨ˆçµæœã‚’Firebaseã«ä¿å­˜
            async saveAggregationResults(date, analysis) {
                try {
                    const saveRef = database.ref(`data-aggregation/${this.currentUser.uid}/${date}`);
                    await saveRef.set(analysis);
                    this.log('é›†è¨ˆçµæœä¿å­˜å®Œäº†', { date: date, path: saveRef.toString() });
                } catch (error) {
                    this.log('âŒ é›†è¨ˆçµæœä¿å­˜ã‚¨ãƒ©ãƒ¼', error.message);
                }
            }

            // å…¨æœŸé–“é›†è¨ˆ
            async aggregateAllDates() {
                if (!this.currentUser) {
                    alert('Googleãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                    return;
                }

                this.log('=== å…¨æœŸé–“é›†è¨ˆé–‹å§‹ ===');
                
                try {
                    const snapshot = await database.ref('/').once('value');
                    const allData = snapshot.val() || {};
                    
                    // å…¨æ—¥ä»˜ã‚’æŠ½å‡º
                    const dates = this.extractDatesFromData(allData);
                    this.log('ç™ºè¦‹ã•ã‚ŒãŸæ—¥ä»˜', dates);

                    let totalProcessed = 0;
                    for (const date of dates) {
                        await this.aggregateData(date);
                        totalProcessed++;
                        this.log(`é€²æ—: ${totalProcessed}/${dates.length}`, { currentDate: date });
                    }

                    this.log('âœ… å…¨æœŸé–“é›†è¨ˆå®Œäº†', { 
                        totalDates: dates.length,
                        processed: totalProcessed 
                    });

                } catch (error) {
                    this.log('âŒ å…¨æœŸé–“é›†è¨ˆã‚¨ãƒ©ãƒ¼', error.message);
                }
            }

            // ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ—¥ä»˜ã‚’æŠ½å‡º
            extractDatesFromData(data) {
                const dates = new Set();
                
                const findDates = (obj, path = '') => {
                    if (!obj || typeof obj !== 'object') return;
                    
                    for (const [key, value] of Object.entries(obj)) {
                        // æ—¥ä»˜å½¢å¼ã®ã‚­ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
                        if (key.match(/^\d{4}-\d{2}-\d{2}$/)) {
                            dates.add(key);
                        }
                        if (typeof value === 'object' && value !== null) {
                            findDates(value, path + '/' + key);
                        }
                    }
                };

                findDates(data);
                return Array.from(dates).sort();
            }

            // è‡ªå‹•é›†è¨ˆæœ‰åŠ¹/ç„¡åŠ¹åˆ‡ã‚Šæ›¿ãˆ
            toggleAutoAggregation() {
                this.autoAggregationEnabled = !this.autoAggregationEnabled;
                
                const autoSwitch = document.getElementById('autoSwitch');
                const autoStatus = document.getElementById('autoStatus');
                
                if (this.autoAggregationEnabled) {
                    autoSwitch.classList.add('active');
                    autoStatus.textContent = 'ON';
                    this.startAutoAggregation();
                    this.log('ğŸ¤– è‡ªå‹•é›†è¨ˆã‚·ã‚¹ãƒ†ãƒ æœ‰åŠ¹åŒ–');
                } else {
                    autoSwitch.classList.remove('active');
                    autoStatus.textContent = 'OFF';
                    this.stopAutoAggregation();
                    this.log('ğŸ¤– è‡ªå‹•é›†è¨ˆã‚·ã‚¹ãƒ†ãƒ ç„¡åŠ¹åŒ–');
                }
                
                this.saveSettings();
            }

            // è‡ªå‹•é›†è¨ˆé–‹å§‹
            startAutoAggregation() {
                // æ¯æ—¥åˆå‰0æ™‚ã«å®Ÿè¡Œã™ã‚‹ãƒã‚§ãƒƒã‚¯
                this.autoAggregationInterval = setInterval(() => {
                    const now = new Date();
                    if (now.getHours() === 0 && now.getMinutes() === 0) {
                        const yesterday = new Date(now);
                        yesterday.setDate(yesterday.getDate() - 1);
                        const dateStr = yesterday.toISOString().split('T')[0];
                        
                        this.log('ğŸ¤– è‡ªå‹•é›†è¨ˆå®Ÿè¡Œ', { date: dateStr });
                        this.aggregateData(dateStr);
                    }
                }, 60000); // 1åˆ†ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
            }

            // è‡ªå‹•é›†è¨ˆåœæ­¢
            stopAutoAggregation() {
                if (this.autoAggregationInterval) {
                    clearInterval(this.autoAggregationInterval);
                    this.autoAggregationInterval = null;
                }
            }

            // è‡ªå‹•é›†è¨ˆãƒã‚§ãƒƒã‚¯
            checkAutoAggregation() {
                // ç¾åœ¨æ™‚åˆ»ãŒåˆå‰0æ™‚00åˆ†ã®å ´åˆã«å‰æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
                const now = new Date();
                if (now.getHours() === 0 && now.getMinutes() === 0) {
                    const yesterday = new Date(now);
                    yesterday.setDate(yesterday.getDate() - 1);
                    const dateStr = yesterday.toISOString().split('T')[0];
                    
                    this.log('ğŸ¤– è‡ªå‹•é›†è¨ˆå®Ÿè¡Œ', { date: dateStr, time: now.toISOString() });
                    this.aggregateData(dateStr);
                }
            }

            // è¨­å®šä¿å­˜
            saveSettings() {
                localStorage.setItem('firebase-aggregator-settings', JSON.stringify({
                    autoAggregationEnabled: this.autoAggregationEnabled
                }));
            }

            // è¨­å®šèª­ã¿è¾¼ã¿
            loadSettings() {
                const settings = JSON.parse(localStorage.getItem('firebase-aggregator-settings') || '{}');
                if (settings.autoAggregationEnabled) {
                    this.toggleAutoAggregation();
                }
            }

            // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
            async testDataGeneration() {
                if (!this.currentUser) {
                    alert('Googleãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                    return;
                }

                this.log('ğŸ§ª ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆé–‹å§‹');
                
                const testDates = ['2025-08-15', '2025-08-14', '2025-08-13'];
                const apps = ['webapp-template', 'money-tracker', 'test-app'];
                
                for (const date of testDates) {
                    for (const app of apps) {
                        const recordCount = Math.floor(Math.random() * 10) + 1;
                        
                        for (let i = 0; i < recordCount; i++) {
                            const testRecord = {
                                id: `test_${Date.now()}_${i}`,
                                type: Math.random() > 0.5 ? 'income' : 'expense',
                                amount: Math.floor(Math.random() * 10000) + 100,
                                content: `ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿_${app}_${i}`,
                                timestamp: Date.now() + i
                            };

                            const path = `${app}/${this.currentUser.uid}/${date}/${testRecord.id}`;
                            await database.ref(path).set(testRecord);
                        }
                    }
                }

                this.log('âœ… ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†', {
                    dates: testDates.length,
                    apps: apps.length,
                    estimatedRecords: testDates.length * apps.length * 5
                });
            }

            // é›†è¨ˆãƒ†ã‚¹ãƒˆ
            async testAggregation() {
                this.log('ğŸ§ª é›†è¨ˆãƒ†ã‚¹ãƒˆé–‹å§‹');
                await this.aggregateData('2025-08-15');
                this.log('âœ… é›†è¨ˆãƒ†ã‚¹ãƒˆå®Œäº†');
            }

            // æœ¬æ—¥å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®ã¿æŠ½å‡º
            async extractTodayInputData() {
                if (!this.currentUser) {
                    alert('Googleãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                    return;
                }

                const today = new Date().toISOString().split('T')[0];
                this.log('ğŸ“… æœ¬æ—¥å…¥åŠ›ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºé–‹å§‹', { date: today });
                
                try {
                    // å…¨ã‚¢ãƒ—ãƒªã‹ã‚‰æœ¬æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡º
                    const snapshot = await database.ref('/').once('value');
                    const allData = snapshot.val() || {};
                    
                    const todayData = {};
                    
                    // æœ¬æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’å†å¸°çš„ã«æŠ½å‡º
                    this.extractTodayDataRecursive(allData, '', todayData, today);
                    
                    // æŠ½å‡ºçµæœã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    const exportData = {
                        date: today,
                        user: this.currentUser.email,
                        extracted: new Date().toISOString(),
                        totalRecords: this.countRecords(todayData),
                        data: todayData
                    };

                    const dataStr = JSON.stringify(exportData, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `today-input-data-${today}.json`;
                    a.click();
                    URL.revokeObjectURL(url);

                    this.log('âœ… æœ¬æ—¥å…¥åŠ›ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºå®Œäº†', { 
                        date: today,
                        recordCount: exportData.totalRecords,
                        fileSize: blob.size 
                    });
                    
                } catch (error) {
                    this.log('âŒ æœ¬æ—¥ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºã‚¨ãƒ©ãƒ¼', error.message);
                }
            }

            // æœ¬æ—¥ãƒ‡ãƒ¼ã‚¿å†å¸°æŠ½å‡º
            extractTodayDataRecursive(data, path, result, targetDate) {
                if (!data || typeof data !== 'object') return;

                for (const [key, value] of Object.entries(data)) {
                    if (key === targetDate && typeof value === 'object') {
                        // æœ¬æ—¥ã®æ—¥ä»˜ã‚­ãƒ¼ã‚’ç™ºè¦‹
                        const pathParts = path.split('/').filter(p => p);
                        let current = result;
                        
                        // ãƒ‘ã‚¹æ§‹é€ ã‚’å†ç¾
                        for (const part of pathParts) {
                            if (!current[part]) current[part] = {};
                            current = current[part];
                        }
                        current[key] = value;
                        
                        this.log('æœ¬æ—¥ãƒ‡ãƒ¼ã‚¿ç™ºè¦‹', { path: path + '/' + key, recordCount: this.countRecords(value) });
                    } else if (typeof value === 'object' && value !== null) {
                        this.extractTodayDataRecursive(value, path ? `${path}/${key}` : key, result, targetDate);
                    }
                }
            }

            // GitHubã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
            async uploadToGitHub() {
                if (!this.currentUser) {
                    alert('Googleãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                    return;
                }

                this.log('ğŸš€ GitHubã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æº–å‚™é–‹å§‹');
                
                try {
                    // é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                    const snapshot = await database.ref(`data-aggregation/${this.currentUser.uid}`).once('value');
                    const aggregationData = snapshot.val() || {};
                    
                    // GitHubã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ã®ãƒ‡ãƒ¼ã‚¿æº–å‚™
                    const uploadData = {
                        title: 'Firebase DB æ¯æ—¥é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆ',
                        generated: new Date().toISOString(),
                        user: this.currentUser.email,
                        summary: {
                            totalDates: Object.keys(aggregationData).length,
                            latestDate: Math.max(...Object.keys(aggregationData).map(d => new Date(d).getTime())),
                            totalRecords: Object.values(aggregationData).reduce((sum, data) => sum + (data.totalRecords || 0), 0)
                        },
                        data: aggregationData
                    };

                    // READMEå½¢å¼ã®ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ç”Ÿæˆ
                    const markdown = this.generateMarkdownReport(uploadData);
                    
                    // ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ï¼ˆGitHubæ‰‹å‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
                    const mdBlob = new Blob([markdown], { type: 'text/markdown' });
                    const jsonBlob = new Blob([JSON.stringify(uploadData, null, 2)], { type: 'application/json' });
                    
                    // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    const mdUrl = URL.createObjectURL(mdBlob);
                    const mdA = document.createElement('a');
                    mdA.href = mdUrl;
                    mdA.download = `firebase-report-${new Date().toISOString().split('T')[0]}.md`;
                    mdA.click();
                    URL.revokeObjectURL(mdUrl);
                    
                    // JSONãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    const jsonUrl = URL.createObjectURL(jsonBlob);
                    const jsonA = document.createElement('a');
                    jsonA.href = jsonUrl;
                    jsonA.download = `firebase-data-${new Date().toISOString().split('T')[0]}.json`;
                    jsonA.click();
                    URL.revokeObjectURL(jsonUrl);

                    this.log('âœ… GitHubã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆå®Œäº†', { 
                        mdFileSize: mdBlob.size,
                        jsonFileSize: jsonBlob.size,
                        note: 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ‰‹å‹•ã§GitHubã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„'
                    });
                    
                    alert('GitHubã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§GitHubãƒªãƒã‚¸ãƒˆãƒªã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
                    
                } catch (error) {
                    this.log('âŒ GitHubã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æº–å‚™ã‚¨ãƒ©ãƒ¼', error.message);
                }
            }

            // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
            generateMarkdownReport(data) {
                const latestDateStr = new Date(data.summary.latestDate).toLocaleDateString('ja-JP');
                
                return `# Firebase DB æ¯æ—¥é›†è¨ˆãƒ¬ãƒãƒ¼ãƒˆ

## ğŸ“Š é›†è¨ˆã‚µãƒãƒªãƒ¼

- **ç”Ÿæˆæ—¥æ™‚**: ${new Date(data.generated).toLocaleString('ja-JP')}
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼**: ${data.user}
- **é›†è¨ˆæœŸé–“**: ${data.summary.totalDates} æ—¥é–“
- **æœ€æ–°ãƒ‡ãƒ¼ã‚¿**: ${latestDateStr}
- **ç·ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°**: ${data.summary.totalRecords.toLocaleString()} ä»¶

## ğŸ“… æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿

${Object.entries(data.data).map(([date, info]) => `
### ${date}
- **ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°**: ${info.totalRecords} ä»¶
- **ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º**: ${this.formatBytes(info.totalDataLength)}
- **å¹³å‡ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚µã‚¤ã‚º**: ${this.formatBytes(info.avgRecordSize)}
${info.dataByApp ? Object.entries(info.dataByApp).map(([app, appData]) => 
`  - **${app}**: ${appData.records} ä»¶ (${this.formatBytes(appData.size)})`).join('\n') : ''}
`).join('\n')}

## ğŸ› ï¸ ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ 

ã“ã®ãƒ¬ãƒãƒ¼ãƒˆã¯ Firebase DB æ¯æ—¥é›†è¨ˆã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

- **ã‚·ã‚¹ãƒ†ãƒ **: firebase-daily-data-aggregator.html
- **Firebase DB**: shares-b1b97
- **è‡ªå‹•é›†è¨ˆ**: æ¯æ—¥åˆå‰0æ™‚å®Ÿè¡Œ

---
*Generated by Firebase DB æ¯æ—¥é›†è¨ˆã‚·ã‚¹ãƒ†ãƒ *
`;
            }

            // Firebaseæ–™é‡‘ãƒã‚§ãƒƒã‚¯
            async checkFirebaseCost() {
                this.log('ğŸ’° Firebaseæ–™é‡‘ãƒã‚§ãƒƒã‚¯é–‹å§‹');
                
                try {
                    // Firebase DBå…¨ä½“ã®ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºã‚’å–å¾—
                    const snapshot = await database.ref('/').once('value');
                    const allData = snapshot.val() || {};
                    const dataStr = JSON.stringify(allData);
                    const totalSize = new Blob([dataStr]).size;
                    
                    // Firebaseæ–™é‡‘è¨ˆç®—ï¼ˆ2025å¹´æ–™é‡‘ä½“ç³»ï¼‰
                    const pricing = {
                        // Realtime Databaseæ–™é‡‘ï¼ˆç„¡æ–™æ ï¼‰
                        freeTier: {
                            storage: 1024 * 1024 * 1024, // 1GB
                            bandwidth: 10 * 1024 * 1024 * 1024, // 10GB/æœˆ
                            connections: 100
                        },
                        // æœ‰æ–™æ–™é‡‘
                        paid: {
                            storagePerGB: 5, // $5/GB/æœˆ
                            bandwidthPerGB: 1, // $1/GB
                            connectionsPer100: 1 // $1/100åŒæ™‚æ¥ç¶š
                        }
                    };
                    
                    const storageUsagePercent = (totalSize / pricing.freeTier.storage * 100).toFixed(2);
                    const storageOverage = Math.max(0, totalSize - pricing.freeTier.storage);
                    const estimatedMonthlyCost = (storageOverage / (1024 * 1024 * 1024)) * pricing.paid.storagePerGB;
                    
                    const costInfo = {
                        totalDataSize: totalSize,
                        formattedSize: this.formatBytes(totalSize),
                        storageUsagePercent: storageUsagePercent,
                        isOverFreeLimit: totalSize > pricing.freeTier.storage,
                        freeLimit: this.formatBytes(pricing.freeTier.storage),
                        overage: this.formatBytes(storageOverage),
                        estimatedMonthlyCost: estimatedMonthlyCost.toFixed(2),
                        recommendations: []
                    };
                    
                    // æ–™é‡‘ç¯€ç´„ã®æ¨å¥¨äº‹é …
                    if (storageUsagePercent > 80) {
                        costInfo.recommendations.push('âš ï¸ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ãŒ80%ã‚’è¶…ãˆã¦ã„ã¾ã™');
                    }
                    if (costInfo.isOverFreeLimit) {
                        costInfo.recommendations.push('ğŸ’¸ ç„¡æ–™æ ã‚’è¶…éã—ã¦ã„ã¾ã™ã€‚å¤ã„ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤ã‚’æ¤œè¨ã—ã¦ãã ã•ã„');
                    }
                    if (storageUsagePercent > 50) {
                        costInfo.recommendations.push('ğŸ“Š ãƒ‡ãƒ¼ã‚¿åœ§ç¸®ã‚„ä¸è¦ãƒ¬ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤ã‚’æ¤œè¨ã—ã¦ãã ã•ã„');
                    }
                    
                    // ã‚³ã‚¹ãƒˆæƒ…å ±ã‚’UIè¡¨ç¤ºç”¨ã«æ›´æ–°
                    this.displayCostInfo(costInfo);
                    
                    this.log('âœ… Firebaseæ–™é‡‘ãƒã‚§ãƒƒã‚¯å®Œäº†', costInfo);
                    
                } catch (error) {
                    this.log('âŒ æ–™é‡‘ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼', error.message);
                }
            }

            // ã‚³ã‚¹ãƒˆæƒ…å ±è¡¨ç¤º
            displayCostInfo(costInfo) {
                // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½¿ç”¨é‡ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
                const storageUsageElement = document.getElementById('storageUsage');
                if (storageUsageElement) {
                    storageUsageElement.textContent = costInfo.storageUsagePercent + ' %';
                    storageUsageElement.style.color = costInfo.isOverFreeLimit ? 'var(--danger)' : 
                                                    costInfo.storageUsagePercent > 80 ? 'var(--warning)' : 'var(--primary)';
                }
                
                // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
                if (costInfo.isOverFreeLimit) {
                    alert(`âš ï¸ Firebaseç„¡æ–™æ è¶…é\n` +
                          `ç¾åœ¨ã®ä½¿ç”¨é‡: ${costInfo.formattedSize}\n` +
                          `ç„¡æ–™æ : ${costInfo.freeLimit}\n` +
                          `è¶…éåˆ†: ${costInfo.overage}\n` +
                          `æ¨å®šæœˆé¡æ–™é‡‘: $${costInfo.estimatedMonthlyCost}`);
                } else {
                    alert(`âœ… Firebaseæ–™é‡‘ãƒã‚§ãƒƒã‚¯å®Œäº†\n` +
                          `ç¾åœ¨ã®ä½¿ç”¨é‡: ${costInfo.formattedSize}\n` +
                          `ç„¡æ–™æ ä½¿ç”¨ç‡: ${costInfo.storageUsagePercent}%\n` +
                          `æ®‹ã‚Šå®¹é‡: ${this.formatBytes(1024*1024*1024 - costInfo.totalDataSize)}`);
                }
            }

            // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            async exportData() {
                if (!this.currentUser) {
                    alert('Googleãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã§ã™');
                    return;
                }

                this.log('ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé–‹å§‹');
                
                try {
                    const snapshot = await database.ref(`data-aggregation/${this.currentUser.uid}`).once('value');
                    const aggregationData = snapshot.val() || {};
                    
                    const exportData = {
                        user: this.currentUser.email,
                        exported: new Date().toISOString(),
                        aggregations: aggregationData
                    };

                    const dataStr = JSON.stringify(exportData, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `firebase-aggregation-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);

                    this.log('âœ… ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†', { fileSize: blob.size });
                    
                } catch (error) {
                    this.log('âŒ ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼', error.message);
                }
            }
        }

        // ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
        const aggregator = new FirebaseDataAggregator();

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°
        function signIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(result => {
                    aggregator.log('ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ', result.user.email);
                })
                .catch(error => {
                    aggregator.log('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼', error.message);
                });
        }

        function signOut() {
            auth.signOut();
        }

        function aggregateData() {
            aggregator.aggregateData();
        }

        function aggregateAllDates() {
            aggregator.aggregateAllDates();
        }

        function toggleAutoAggregation() {
            aggregator.toggleAutoAggregation();
        }

        function testDataGeneration() {
            aggregator.testDataGeneration();
        }

        function testAggregation() {
            aggregator.testAggregation();
        }

        function extractTodayInputData() {
            aggregator.extractTodayInputData();
        }

        function uploadToGitHub() {
            aggregator.uploadToGitHub();
        }

        function checkFirebaseCost() {
            aggregator.checkFirebaseCost();
        }

        function exportData() {
            aggregator.exportData();
        }

        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°é–¢æ•°
        function toggleDebug() {
            document.getElementById('debugLog').classList.toggle('show');
        }

        function copyDebugLog() {
            const debugContent = document.getElementById('debugContent');
            const text = debugContent.innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert('ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            });
        }

        function downloadDebugLog() {
            const debugContent = document.getElementById('debugContent');
            const logText = debugContent.innerText;
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
            const filename = `firebase-aggregator-log_${timestamp}.txt`;
            
            const logHeader = [
                '=== Firebase DBæ¯æ—¥é›†è¨ˆã‚·ã‚¹ãƒ†ãƒ  Debug Log ===',
                `Generated: ${new Date().toLocaleString('ja-JP')}`,
                `User: ${aggregator.currentUser ? aggregator.currentUser.email : 'Guest'}`,
                `URL: ${window.location.href}`,
                '=' .repeat(50),
                ''
            ].join('\n');
            
            const fullLogContent = logHeader + logText;
            
            const blob = new Blob([fullLogContent], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            aggregator.log(`ğŸ“¥ ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ: ${filename}`, { fileSize: blob.size });
        }

        function clearDebugLog() {
            document.getElementById('debugContent').innerHTML = '';
            aggregator.log('ãƒ­ã‚°ã‚¯ãƒªã‚¢å®Œäº†');
        }

        // ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå°‚ç”¨ãƒ‡ãƒãƒƒã‚°é–¢æ•°
        function showDebugInfo() {
            const debugOutput = document.getElementById('tabletDebugOutput');
            const debugContent = document.getElementById('tabletDebugContent');
            
            const systemInfo = {
                timestamp: new Date().toLocaleString('ja-JP'),
                userAgent: navigator.userAgent,
                screenSize: `${screen.width}x${screen.height}`,
                viewportSize: `${window.innerWidth}x${window.innerHeight}`,
                deviceType: window.innerWidth < 768 ? 'Mobile' : window.innerWidth < 1024 ? 'Tablet' : 'Desktop',
                online: navigator.onLine,
                language: navigator.language,
                platform: navigator.platform,
                cookieEnabled: navigator.cookieEnabled,
                firebaseUser: aggregator.currentUser ? aggregator.currentUser.email : 'ãƒ­ã‚°ã‚¤ãƒ³ãªã—',
                firebaseUID: aggregator.currentUser ? aggregator.currentUser.uid : 'N/A',
                currentURL: window.location.href
            };

            let html = '<h4>ğŸ” ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</h4>';
            for (const [key, value] of Object.entries(systemInfo)) {
                html += `<div><strong>${key}:</strong> ${value}</div>`;
            }

            debugContent.innerHTML = html;
            debugOutput.style.display = debugOutput.style.display === 'none' ? 'block' : 'none';
            
            aggregator.log('ğŸ“± ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±è¡¨ç¤º', systemInfo);
        }

        function showFullLog() {
            const debugOutput = document.getElementById('tabletDebugOutput');
            const debugContent = document.getElementById('tabletDebugContent');
            
            const debugLogContent = document.getElementById('debugContent').innerHTML;
            
            debugContent.innerHTML = `
                <h4>ğŸ“‹ ãƒ•ãƒ«ãƒ­ã‚°</h4>
                <div style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px;">
                    ${debugLogContent || 'ãƒ­ã‚°ãŒã‚ã‚Šã¾ã›ã‚“'}
                </div>
                <button onclick="copyFullLog()" style="margin-top: 10px; padding: 5px 10px;">ğŸ“‹ å…¨ãƒ­ã‚°ã‚³ãƒ”ãƒ¼</button>
            `;
            
            debugOutput.style.display = debugOutput.style.display === 'none' ? 'block' : 'none';
            aggregator.log('ğŸ“‹ ãƒ•ãƒ«ãƒ­ã‚°è¡¨ç¤ºå®Œäº†');
        }

        function copyFullLog() {
            const debugLogContent = document.getElementById('debugContent').innerText;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(debugLogContent).then(() => {
                    alert('âœ… å…¨ãƒ­ã‚°ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
                });
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                const textarea = document.createElement('textarea');
                textarea.value = debugLogContent;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('âœ… å…¨ãƒ­ã‚°ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰');
            }
            aggregator.log('ğŸ“‹ å…¨ãƒ­ã‚°ã‚³ãƒ”ãƒ¼å®Œäº†');
        }

        function exportDebugReport() {
            const systemInfo = {
                timestamp: new Date().toLocaleString('ja-JP'),
                userAgent: navigator.userAgent,
                screenSize: `${screen.width}x${screen.height}`,
                viewportSize: `${window.innerWidth}x${window.innerHeight}`,
                firebaseUser: aggregator.currentUser ? aggregator.currentUser.email : 'ãƒ­ã‚°ã‚¤ãƒ³ãªã—',
                firebaseUID: aggregator.currentUser ? aggregator.currentUser.uid : 'N/A'
            };

            const debugLogContent = document.getElementById('debugContent').innerText;
            
            const report = {
                title: 'Firebase DBæ¯æ—¥é›†è¨ˆã‚·ã‚¹ãƒ†ãƒ  - ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒãƒ¼ãƒˆ',
                generated: new Date().toISOString(),
                systemInfo: systemInfo,
                logs: debugLogContent,
                note: 'ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå°‚ç”¨ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«ã§ç”Ÿæˆ'
            };

            const reportStr = JSON.stringify(report, null, 2);
            const blob = new Blob([reportStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `firebase-debug-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            aggregator.log('ğŸ“Š ãƒ‡ãƒãƒƒã‚°ãƒ¬ãƒãƒ¼ãƒˆä½œæˆå®Œäº†', { fileSize: blob.size });
        }
    </script>
</body>
</html>