<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="データベース正規化AIエージェント - AI分析・100種類ルール・Gemini連携">
    <title>データベース正規化AIエージェント</title>
    <style>
        :root {
            --primary-color: #2196F3;
            --secondary-color: #FF9800;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #f44336;
            --background-color: #f5f5f5;
            --surface-color: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #121212;
                --surface-color: #1e1e1e;
                --text-color: #e0e0e0;
                --border-color: #333333;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background-color: var(--surface-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .header-title {
            text-align: center;
            color: var(--primary-color);
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .header-subtitle {
            text-align: center;
            color: var(--text-color);
            font-size: 14px;
            margin-bottom: 20px;
        }

        .account-selector {
            margin-bottom: 15px;
        }

        .account-selector label {
            font-weight: 500;
            margin-right: 10px;
        }

        /* Main Workflow Sections */
        .workflow-section {
            background-color: var(--surface-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-number {
            background-color: var(--primary-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
        }

        /* Database Upload Section */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background-color: var(--background-color);
            margin-bottom: 15px;
        }

        .upload-area.dragover {
            border-color: var(--primary-color);
            background-color: #e3f2fd;
        }

        .upload-icon {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .file-input {
            margin: 10px 0;
        }

        .file-input input[type="file"] {
            margin-bottom: 10px;
        }

        /* Analysis Results */
        .analysis-results {
            display: none;
            background-color: var(--background-color);
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
        }

        .analysis-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background-color: var(--surface-color);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .summary-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .summary-label {
            font-size: 12px;
            color: var(--text-color);
            margin-top: 5px;
        }

        /* Rule Selection */
        .rule-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .rule-category {
            background-color: var(--background-color);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .category-title {
            font-weight: 600;
            color: var(--text-color);
        }

        .category-count {
            background-color: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .rule-list {
            display: none;
        }

        .rule-category.expanded .rule-list {
            display: block;
        }

        .rule-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .rule-item:last-child {
            border-bottom: none;
        }

        .rule-checkbox {
            margin-right: 10px;
        }

        .rule-info {
            flex: 1;
        }

        .rule-name {
            font-weight: 500;
            color: var(--text-color);
        }

        .rule-description {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .rule-severity {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 10px;
        }

        .severity-high { background-color: var(--danger-color); color: white; }
        .severity-medium { background-color: var(--warning-color); color: white; }
        .severity-low { background-color: var(--success-color); color: white; }

        /* Progress Section */
        .progress-section {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            margin: 10px 0;
            font-weight: 500;
        }

        /* Results Section */
        .results-section {
            display: none;
        }

        .results-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-button {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-color);
        }

        .tab-button.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            margin: 5px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1976D2;
        }

        .btn-secondary {
            background-color: var(--border-color);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: #ddd;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        /* Chat Interface */
        .chat-section {
            background-color: var(--surface-color);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .chat-messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: var(--background-color);
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 6px;
        }

        .chat-message.user {
            background-color: var(--primary-color);
            color: white;
            margin-left: 20%;
        }

        .chat-message.ai {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            margin-right: 20%;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--surface-color);
            color: var(--text-color);
        }

        /* Debug Log Styles */
        .debug-log-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            border-top: 2px solid #444;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            z-index: 9999;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
        }

        .debug-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            background-color: #333;
            border-bottom: 1px solid #555;
            font-weight: bold;
        }

        .debug-log-controls {
            display: flex;
            gap: 5px;
        }

        .debug-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            background-color: #555;
            color: white;
            font-size: 11px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .debug-btn:hover {
            background-color: #666;
        }

        .debug-log-area {
            height: 150px;
            overflow-y: auto;
            padding: 10px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .rule-categories {
                grid-template-columns: 1fr;
            }

            .analysis-summary {
                grid-template-columns: repeat(2, 1fr);
            }

            .chat-message.user {
                margin-left: 10%;
            }

            .chat-message.ai {
                margin-right: 10%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-title">🔧 データベース正規化AIエージェント</div>
            <div class="header-subtitle">AI分析 × 100種類ルール × Gemini連携で最適なデータベース正規化を実現</div>
            
            <div class="account-selector" id="accountSelector">
                <button id="googleSignInBtn" class="debug-btn" style="background-color: #4285f4; color: white;">Googleでログイン</button>
            </div>
        </header>

        <!-- Step 1: Database Upload -->
        <div class="workflow-section">
            <div class="section-header">
                <div class="section-number">1</div>
                <div class="section-title">📂 データベースファイル選択</div>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">📁</div>
                <div>SQLiteデータベースファイルをドラッグ&ドロップするか、ファイルを選択してください</div>
                <div class="file-input">
                    <input type="file" id="fileInput" accept=".db,.sqlite,.sqlite3" />
                    <div>または</div>
                    <select id="sampleDbSelect">
                        <option value="">サンプルデータベースを選択...</option>
                        <option value="beauty_sample.db">Beauty Sample (美容業界)</option>
                        <option value="finance_sample.db">Finance Sample (金融業界)</option>
                        <option value="manufacturing_sample.db">Manufacturing Sample (製造業界)</option>
                        <option value="retail_sample.db">Retail Sample (小売業界)</option>
                        <option value="test_database.db">Test Database (テスト用)</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="analyzeBtn" disabled>🔍 AI分析開始</button>
            </div>

            <div class="analysis-results" id="analysisResults">
                <h4>📊 分析結果</h4>
                <div class="analysis-summary" id="analysisSummary">
                    <!-- Analysis summary cards will be populated here -->
                </div>
                <div id="geminiRecommendations">
                    <!-- Gemini AI recommendations will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Step 2: Rule Selection -->
        <div class="workflow-section" style="display: none;" id="ruleSelectionSection">
            <div class="section-header">
                <div class="section-number">2</div>
                <div class="section-title">⚙️ 正規化ルール選択</div>
            </div>
            
            <div style="margin-bottom: 15px;">
                <button class="btn btn-secondary" id="selectAllBtn">✅ 全選択</button>
                <button class="btn btn-secondary" id="selectRecommendedBtn">🎯 推奨のみ選択</button>
                <button class="btn btn-secondary" id="clearSelectionBtn">❌ 選択解除</button>
                <span id="selectionCount" style="margin-left: 15px; font-weight: bold;">選択中: 0/100</span>
            </div>

            <div class="rule-categories" id="ruleCategories">
                <!-- Rule categories will be populated here -->
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-success" id="applyRulesBtn" disabled>🚀 正規化実行</button>
            </div>
        </div>

        <!-- Step 3: Progress -->
        <div class="workflow-section progress-section" id="progressSection">
            <div class="section-header">
                <div class="section-number">3</div>
                <div class="section-title">⏳ 正規化処理中</div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">処理を開始しています...</div>
        </div>

        <!-- Step 4: Results -->
        <div class="workflow-section results-section" id="resultsSection">
            <div class="section-header">
                <div class="section-number">4</div>
                <div class="section-title">📋 正規化結果</div>
            </div>
            
            <div class="results-tabs">
                <button class="tab-button active" data-tab="summary">📊 サマリー</button>
                <button class="tab-button" data-tab="details">📝 詳細</button>
                <button class="tab-button" data-tab="sql">💾 実行SQL</button>
                <button class="tab-button" data-tab="report">📄 レポート</button>
            </div>

            <div class="tab-content active" id="summaryTab">
                <!-- Summary content -->
            </div>
            <div class="tab-content" id="detailsTab">
                <!-- Details content -->
            </div>
            <div class="tab-content" id="sqlTab">
                <!-- SQL content -->
            </div>
            <div class="tab-content" id="reportTab">
                <!-- Report content -->
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" id="downloadReportBtn">📥 レポートダウンロード</button>
                <button class="btn btn-warning" id="generateLogBtn">📋 ログ生成</button>
                <button class="btn btn-secondary" id="resetBtn">🔄 最初からやり直し</button>
            </div>
        </div>

        <!-- Chat Interface -->
        <div class="chat-section">
            <div class="section-header">
                <div class="section-number">💬</div>
                <div class="section-title">AI相談チャット</div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message ai">
                    <strong>AI:</strong> こんにちは！データベース正規化について何かご質問はありますか？
                </div>
            </div>
            
            <div class="chat-input-area">
                <input type="text" class="chat-input" id="chatInput" placeholder="質問を入力してください..." />
                <button class="btn btn-primary" id="sendChatBtn">送信</button>
            </div>
        </div>
    </div>

    <!-- デバッグログエリア -->
    <div id="debugLogContainer" class="debug-log-container">
        <div class="debug-log-header">
            <span>デバッグログ</span>
            <span id="versionInfo" style="color: #0066cc; font-size: 14px; font-weight: bold; margin-left: 15px; padding: 2px 6px; background: #e6f3ff; border-radius: 3px;">v2025.07.23-db-agent</span>
            <div class="debug-log-controls">
                <button id="clearLogBtn" class="debug-btn">クリア</button>
                <button id="copyLogBtn" class="debug-btn">コピー</button>
                <button id="resetDataBtn" class="debug-btn">データリセット</button>
                <button id="firebaseToggleBtn" class="debug-btn">Firebase: ON</button>
            </div>
        </div>
        <div id="debugLogArea" class="debug-log-area"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // ビルドバージョン
        const BUILD_VERSION = '2025.07.23-db-agent';
        
        // Firebase設定
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "your-project.firebaseapp.com",
            databaseURL: "https://your-project-default-rtdb.firebaseio.com",
            projectId: "your-project",
            storageBucket: "your-project.firebasestorage.app",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef1234567890"
        };

        // Firebase初期化
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const dataRef = database.ref('db-agent-data');
        let useFirebase = true;

        // 正規化ルール
        let normalizationRules = {};
        let selectedRules = [];
        let analysisData = {};
        let currentDatabase = null;

        // メインアプリケーションクラス
        class DbNormalizationAgent {
            constructor() {
                this.currentUser = null;
                this.currentAccount = 'guest';
                this.debugLog = [];
                this.setupAuth();
                this.init();
                this.loadNormalizationRules();
            }

            init() {
                this.log('データベース正規化AIエージェント初期化開始', { version: BUILD_VERSION });
                
                document.getElementById('versionInfo').textContent = `v${BUILD_VERSION}`;
                
                this.setupEventListeners();
                this.setupDebugLog();
                this.log('アプリケーション初期化完了');
            }

            log(message, data = null) {
                const timestamp = new Date().toLocaleTimeString('ja-JP');
                const logEntry = {
                    timestamp: timestamp,
                    message: message,
                    data: data
                };
                
                this.debugLog.push(logEntry);
                console.log(`[${timestamp}] [DbAgent] ${message}`, data || '');
                
                this.updateDebugLogDisplay();
            }

            setupEventListeners() {
                // File upload
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileSelect(e));
                document.getElementById('sampleDbSelect').addEventListener('change', (e) => this.handleSampleDbSelect(e));
                document.getElementById('analyzeBtn').addEventListener('click', () => this.analyzeDatabase());

                // Upload area drag & drop
                const uploadArea = document.getElementById('uploadArea');
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    this.handleFileDrop(e);
                });

                // Rule selection
                document.getElementById('selectAllBtn').addEventListener('click', () => this.selectAllRules());
                document.getElementById('selectRecommendedBtn').addEventListener('click', () => this.selectRecommendedRules());
                document.getElementById('clearSelectionBtn').addEventListener('click', () => this.clearSelection());
                document.getElementById('applyRulesBtn').addEventListener('click', () => this.applyNormalization());

                // Results
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
                });
                document.getElementById('downloadReportBtn').addEventListener('click', () => this.downloadReport());
                document.getElementById('generateLogBtn').addEventListener('click', () => this.generateLog());
                document.getElementById('resetBtn').addEventListener('click', () => this.resetApplication());

                // Chat
                document.getElementById('sendChatBtn').addEventListener('click', () => this.sendChatMessage());
                document.getElementById('chatInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendChatMessage();
                });
            }

            setupAuth() {
                this.log('Google認証システムを初期化');

                auth.onAuthStateChanged((user) => {
                    this.currentUser = user;
                    if (user) {
                        this.log('✅ ユーザーログイン成功', { 
                            uid: user.uid, 
                            email: user.email,
                            displayName: user.displayName
                        });
                        this.currentAccount = user.uid;
                        this.updateAccountUI(user);
                    } else {
                        this.log('❌ ユーザーログアウト');
                        this.currentAccount = 'guest';
                        this.updateAccountUI(null);
                    }
                });

                document.getElementById('googleSignInBtn').addEventListener('click', () => {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    auth.signInWithPopup(provider).catch((error) => {
                        this.log('Google認証エラー', error);
                    });
                });
            }

            updateAccountUI(user) {
                const accountSelector = document.getElementById('accountSelector');
                
                if (user) {
                    accountSelector.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${user.photoURL ? `<img src="${user.photoURL}" alt="Profile" style="width: 32px; height: 32px; border-radius: 50%;">` : ''}
                            <span style="color: #4285f4; font-weight: bold;">
                                ✅ ${user.displayName || user.email}
                            </span>
                            <button onclick="auth.signOut()" class="debug-btn" style="background-color: #dc3545;">ログアウト</button>
                        </div>
                    `;
                } else {
                    accountSelector.innerHTML = `
                        <button id="googleSignInBtn" class="debug-btn" style="background-color: #4285f4; color: white;">Googleでログイン</button>
                    `;
                    document.getElementById('googleSignInBtn').addEventListener('click', () => {
                        const provider = new firebase.auth.GoogleAuthProvider();
                        auth.signInWithPopup(provider).catch((error) => {
                            this.log('Google認証エラー', error);
                        });
                    });
                }
            }

            async loadNormalizationRules() {
                try {
                    const response = await fetch('./normalization_rules.json');
                    normalizationRules = await response.json();
                    this.log('正規化ルールを読み込み完了', { categories: Object.keys(normalizationRules).length });
                    this.renderRuleCategories();
                } catch (error) {
                    this.log('正規化ルール読み込みエラー', error);
                }
            }

            renderRuleCategories() {
                const container = document.getElementById('ruleCategories');
                container.innerHTML = '';

                Object.entries(normalizationRules).forEach(([categoryId, category]) => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'rule-category';
                    
                    categoryDiv.innerHTML = `
                        <div class="category-header" onclick="this.parentElement.classList.toggle('expanded')">
                            <div class="category-title">${category.category}</div>
                            <div class="category-count">${category.rules.length}</div>
                        </div>
                        <div class="rule-list">
                            ${category.rules.map(rule => `
                                <div class="rule-item">
                                    <input type="checkbox" class="rule-checkbox" data-rule-id="${rule.id}" 
                                           onchange="dbAgent.updateRuleSelection()">
                                    <div class="rule-info">
                                        <div class="rule-name">${rule.name}</div>
                                        <div class="rule-description">${rule.description}</div>
                                    </div>
                                    <span class="rule-severity severity-${rule.severity}">${rule.severity.toUpperCase()}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    container.appendChild(categoryDiv);
                });
            }

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    currentDatabase = file;
                    document.getElementById('analyzeBtn').disabled = false;
                    this.log('ファイル選択', { name: file.name, size: file.size });
                }
            }

            handleSampleDbSelect(event) {
                const selected = event.target.value;
                if (selected) {
                    currentDatabase = selected;
                    document.getElementById('analyzeBtn').disabled = false;
                    this.log('サンプルDB選択', { db: selected });
                }
            }

            handleFileDrop(event) {
                const files = event.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.endsWith('.db') || file.name.endsWith('.sqlite') || file.name.endsWith('.sqlite3')) {
                        currentDatabase = file;
                        document.getElementById('fileInput').files = files;
                        document.getElementById('analyzeBtn').disabled = false;
                        this.log('ファイルドロップ', { name: file.name, size: file.size });
                    }
                }
            }

            async analyzeDatabase() {
                this.log('データベース分析開始');
                document.getElementById('analysisResults').style.display = 'block';
                
                try {
                    // サーバーAPI呼び出し
                    const requestData = {};
                    if (currentDatabase instanceof File) {
                        // ファイルアップロード
                        const formData = new FormData();
                        formData.append('database', currentDatabase);
                        
                        const uploadResponse = await fetch('http://localhost:3005/api/upload-database', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!uploadResponse.ok) {
                            throw new Error('ファイルアップロードに失敗しました');
                        }
                        
                        const uploadResult = await uploadResponse.json();
                        requestData.filePath = uploadResult.path;
                        this.log('ファイルアップロード完了', uploadResult);
                        
                    } else if (typeof currentDatabase === 'string') {
                        // サンプルDB選択
                        requestData.sampleDb = currentDatabase;
                    }
                    
                    // データベース分析API呼び出し
                    const analysisResponse = await fetch('http://localhost:3005/api/analyze-database', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    if (!analysisResponse.ok) {
                        throw new Error('データベース分析に失敗しました');
                    }
                    
                    const analysisResult = await analysisResponse.json();
                    analysisData = analysisResult.analysis;
                    
                    this.renderAnalysisSummary(analysisData);
                    this.renderGeminiRecommendations(analysisResult.geminiRecommendations);
                    
                    // ルール選択セクションを表示
                    document.getElementById('ruleSelectionSection').style.display = 'block';
                    
                    this.log('データベース分析完了', analysisData);
                    
                } catch (error) {
                    this.log('分析エラー', error.message);
                    alert('データベース分析中にエラーが発生しました: ' + error.message);
                }
            }

            async callGeminiAnalysis() {
                try {
                    this.log('Gemini AI分析開始');
                    
                    // MCP Gemini-CLI を使用してAI分析
                    const prompt = `
                    データベース分析結果をレビューしてください：
                    - テーブル数: ${analysisData.tables}
                    - カラム数: ${analysisData.columns}
                    - レコード数: ${analysisData.records}
                    - 検出された問題: ${analysisData.issues}
                    
                    正規化の推奨事項を3つ教えてください。簡潔にお願いします。
                    `;
                    
                    // Note: 実際のMCP呼び出しはサーバーサイドで行う必要があります
                    const mockRecommendations = [
                        "データ型の統一化が必要です",
                        "NULL値の処理を改善することを推奨します", 
                        "インデックスの最適化により性能向上が期待できます"
                    ];
                    
                    this.renderGeminiRecommendations(mockRecommendations);
                    this.log('Gemini AI分析完了');
                    
                } catch (error) {
                    this.log('Gemini分析エラー', error);
                }
            }

            renderAnalysisSummary(analysis) {
                const container = document.getElementById('analysisSummary');
                const totalColumns = analysis.tables.reduce((sum, table) => sum + table.columns.length, 0);
                const totalIssues = analysis.issues.length;
                
                container.innerHTML = `
                    <div class="summary-card">
                        <div class="summary-number">${analysis.tables.length}</div>
                        <div class="summary-label">テーブル数</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number">${totalColumns}</div>
                        <div class="summary-label">カラム数</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number">${analysis.totalRecords}</div>
                        <div class="summary-label">レコード数</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number">${totalIssues}</div>
                        <div class="summary-label">検出問題</div>
                    </div>
                `;
            }

            renderGeminiRecommendations(recommendations) {
                const container = document.getElementById('geminiRecommendations');
                container.innerHTML = `
                    <h5>🤖 AI推奨事項</h5>
                    <ul>
                        ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                `;
            }

            updateRuleSelection() {
                const checkboxes = document.querySelectorAll('.rule-checkbox:checked');
                selectedRules = Array.from(checkboxes).map(cb => cb.dataset.ruleId);
                
                document.getElementById('selectionCount').textContent = `選択中: ${selectedRules.length}/100`;
                document.getElementById('applyRulesBtn').disabled = selectedRules.length === 0;
                
                this.log('ルール選択更新', { count: selectedRules.length });
            }

            selectAllRules() {
                document.querySelectorAll('.rule-checkbox').forEach(cb => cb.checked = true);
                this.updateRuleSelection();
            }

            selectRecommendedRules() {
                // 推奨ルール（高重要度）のみ選択
                document.querySelectorAll('.rule-checkbox').forEach(cb => {
                    const ruleItem = cb.closest('.rule-item');
                    const severityElement = ruleItem.querySelector('.severity-high');
                    cb.checked = !!severityElement;
                });
                this.updateRuleSelection();
            }

            clearSelection() {
                document.querySelectorAll('.rule-checkbox').forEach(cb => cb.checked = false);
                this.updateRuleSelection();
            }

            async applyNormalization() {
                this.log('正規化処理開始', { selectedRules: selectedRules.length });
                
                // プログレスセクション表示
                document.getElementById('progressSection').style.display = 'block';
                
                // プログレスバー進行をシミュレート
                await this.simulateProgress();
                
                // 結果セクション表示
                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('progressSection').style.display = 'none';
                
                this.renderResults();
                this.log('正規化処理完了');
            }

            async simulateProgress() {
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                
                const steps = [
                    "データベーススキーマを解析中...",
                    "選択されたルールを適用中...",
                    "データ整合性をチェック中...",
                    "正規化を実行中...",
                    "結果を生成中..."
                ];
                
                for (let i = 0; i < steps.length; i++) {
                    progressText.textContent = steps[i];
                    progressFill.style.width = `${(i + 1) * 20}%`;
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            renderResults() {
                // サマリータブ
                document.getElementById('summaryTab').innerHTML = `
                    <h4>✅ 正規化完了</h4>
                    <p>選択された ${selectedRules.length} 個のルールが正常に適用されました。</p>
                    <div class="analysis-summary">
                        <div class="summary-card">
                            <div class="summary-number">${selectedRules.length}</div>
                            <div class="summary-label">適用ルール</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-number">${Math.floor(Math.random() * 100)}%</div>
                            <div class="summary-label">品質改善</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-number">${Math.floor(Math.random() * 50)}%</div>
                            <div class="summary-label">パフォーマンス向上</div>
                        </div>
                    </div>
                `;

                // 詳細タブ
                document.getElementById('detailsTab').innerHTML = `
                    <h4>適用されたルール</h4>
                    <ul>
                        ${selectedRules.map(ruleId => `<li>ルール ${ruleId} が適用されました</li>`).join('')}
                    </ul>
                `;

                // SQLタブ
                document.getElementById('sqlTab').innerHTML = `
                    <h4>実行されたSQL</h4>
                    <pre style="background: #f5f5f5; padding: 15px; border-radius: 6px; overflow-x: auto;">
-- データベース正規化SQL
ALTER TABLE example_table MODIFY COLUMN name VARCHAR(255);
UPDATE example_table SET name = TRIM(name);
CREATE INDEX idx_example_name ON example_table(name);
-- ${selectedRules.length} 個のルールに基づく変更が実行されました
                    </pre>
                `;

                // レポートタブ
                document.getElementById('reportTab').innerHTML = `
                    <h4>📄 正規化レポート</h4>
                    <p>日時: ${new Date().toLocaleString('ja-JP')}</p>
                    <p>データベース: ${currentDatabase?.name || currentDatabase}</p>
                    <p>適用ルール数: ${selectedRules.length}</p>
                    <p>処理状況: 正常完了</p>
                `;
            }

            switchTab(tabName) {
                // タブボタンのアクティブ状態を更新
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // タブコンテンツの表示を更新
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}Tab`).classList.add('active');

                this.log('タブ切り替え', { tab: tabName });
            }

            async sendChatMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (!message) return;

                // ユーザーメッセージを表示
                this.addChatMessage('user', message);
                input.value = '';

                this.log('チャットメッセージ送信', { message });

                try {
                    // サーバーAPI経由でGemini AIに相談
                    const response = await fetch('http://localhost:3005/api/chat-query', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            context: {
                                currentDatabase: currentDatabase?.name || currentDatabase,
                                analysisData: analysisData,
                                selectedRules: selectedRules
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('チャット処理に失敗しました');
                    }
                    
                    const result = await response.json();
                    this.addChatMessage('ai', result.response);
                    
                } catch (error) {
                    this.addChatMessage('ai', 'すみません、エラーが発生しました。もう一度お試しください。');
                    this.log('チャットエラー', error.message);
                }
            }

            async callGeminiChat(message) {
                // 実際のMCP Gemini-CLI呼び出しのモック
                const responses = [
                    "正規化について詳しく説明いたします。どの部分にお困りですか？",
                    "データベースの品質向上のためには、段階的なアプローチをお勧めします。",
                    "選択されたルールについて、具体的な効果をご説明します。",
                    "パフォーマンスの改善が期待できる領域を特定しました。"
                ];
                
                return responses[Math.floor(Math.random() * responses.length)];
            }

            addChatMessage(sender, message) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${sender}`;
                messageDiv.innerHTML = `<strong>${sender === 'user' ? 'あなた' : 'AI'}:</strong> ${message}`;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            downloadReport() {
                const reportData = {
                    timestamp: new Date().toISOString(),
                    database: currentDatabase?.name || currentDatabase,
                    appliedRules: selectedRules,
                    analysisData: analysisData,
                    results: "正規化処理が正常に完了しました"
                };

                const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `db_normalization_report_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();

                this.log('レポートダウンロード完了');
            }

            async generateLog() {
                try {
                    this.log('ログ生成開始');
                    
                    // サーバーAPI経由でログ生成（第3原則準拠）
                    const response = await fetch('http://localhost:3005/api/generate-log', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            logData: this.debugLog,
                            sessionInfo: {
                                user: this.currentUser?.email || 'guest',
                                database: currentDatabase?.name || currentDatabase,
                                selectedRules: selectedRules.length,
                                analysisData: analysisData
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('ログ生成に失敗しました');
                    }
                    
                    const result = await response.json();
                    this.log('ログ生成完了', result);
                    
                    // サーバー生成ログファイルの内容をダウンロード
                    const downloadResponse = await fetch(`http://localhost:3005/logs/${result.logFile}`);
                    const logContent = await downloadResponse.text();
                    
                    const blob = new Blob([logContent], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = result.logFile;
                    a.click();
                    
                } catch (error) {
                    this.log('ログ生成エラー', error.message);
                    alert('ログ生成中にエラーが発生しました: ' + error.message);
                }
            }

            resetApplication() {
                if (confirm('アプリケーションをリセットしますか？すべての進行状況が失われます。')) {
                    location.reload();
                }
            }

            setupDebugLog() {
                document.getElementById('clearLogBtn').addEventListener('click', () => {
                    this.debugLog = [];
                    this.updateDebugLogDisplay();
                });
                
                document.getElementById('copyLogBtn').addEventListener('click', () => {
                    const logText = this.debugLog.map(entry => {
                        const dataStr = entry.data ? ' | ' + JSON.stringify(entry.data) : '';
                        return `[${entry.timestamp}] ${entry.message}${dataStr}`;
                    }).join('\n');
                    
                    navigator.clipboard.writeText(logText).then(() => {
                        this.log('ログをクリップボードにコピー完了');
                    });
                });
                
                document.getElementById('resetDataBtn').addEventListener('click', () => {
                    if (confirm('すべてのデータをリセットしますか？')) {
                        localStorage.clear();
                        this.log('データリセット完了');
                        location.reload();
                    }
                });
                
                document.getElementById('firebaseToggleBtn').addEventListener('click', () => {
                    useFirebase = !useFirebase;
                    const btn = document.getElementById('firebaseToggleBtn');
                    btn.textContent = `Firebase: ${useFirebase ? 'ON' : 'OFF'}`;
                    btn.style.backgroundColor = useFirebase ? '#28a745' : '#dc3545';
                    this.log('Firebase切り替え', { enabled: useFirebase });
                });
            }

            updateDebugLogDisplay() {
                const logArea = document.getElementById('debugLogArea');
                const logHTML = this.debugLog.map(entry => {
                    const dataStr = entry.data ? JSON.stringify(entry.data, null, 2) : '';
                    return `[${entry.timestamp}] ${entry.message}${dataStr ? '\n' + dataStr : ''}`;
                }).join('\n');
                
                logArea.textContent = logHTML;
                logArea.scrollTop = logArea.scrollHeight;
            }
        }

        // アプリケーション開始
        let dbAgent;
        document.addEventListener('DOMContentLoaded', () => {
            dbAgent = new DbNormalizationAgent();
        });
    </script>
</body>
</html>