<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ­£è¦åŒ–AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ - AIåˆ†æãƒ»100ç¨®é¡ãƒ«ãƒ¼ãƒ«ãƒ»Geminié€£æº">
    <title>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ­£è¦åŒ–AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</title>
    <style>
        :root {
            --primary-color: #2196F3;
            --secondary-color: #FF9800;
            --success-color: #4CAF50;
            --warning-color: #FF9800;
            --danger-color: #f44336;
            --background-color: #f5f5f5;
            --surface-color: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --background-color: #121212;
                --surface-color: #1e1e1e;
                --text-color: #e0e0e0;
                --border-color: #333333;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background-color: var(--surface-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .header-title {
            text-align: center;
            color: var(--primary-color);
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .header-subtitle {
            text-align: center;
            color: var(--text-color);
            font-size: 14px;
            margin-bottom: 20px;
        }

        .account-selector {
            margin-bottom: 15px;
        }

        .account-selector label {
            font-weight: 500;
            margin-right: 10px;
        }

        /* Main Workflow Sections */
        .workflow-section {
            background-color: var(--surface-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .section-number {
            background-color: var(--primary-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 15px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-color);
        }

        /* Database Upload Section */
        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background-color: var(--background-color);
            margin-bottom: 15px;
        }

        .upload-area.dragover {
            border-color: var(--primary-color);
            background-color: #e3f2fd;
        }

        .upload-icon {
            font-size: 48px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .file-input {
            margin: 10px 0;
        }

        .file-input input[type="file"] {
            margin-bottom: 10px;
        }

        /* Analysis Results */
        .analysis-results {
            display: none;
            background-color: var(--background-color);
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
        }

        .analysis-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .summary-card {
            background-color: var(--surface-color);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .summary-number {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .summary-label {
            font-size: 12px;
            color: var(--text-color);
            margin-top: 5px;
        }

        /* Rule Selection */
        .rule-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .rule-category {
            background-color: var(--background-color);
            border-radius: 8px;
            padding: 15px;
            border: 1px solid var(--border-color);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            cursor: pointer;
        }

        .category-title {
            font-weight: 600;
            color: var(--text-color);
        }

        .category-count {
            background-color: var(--primary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }

        .rule-list {
            display: none;
        }

        .rule-category.expanded .rule-list {
            display: block;
        }

        .rule-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .rule-item:last-child {
            border-bottom: none;
        }

        .rule-checkbox {
            margin-right: 10px;
        }

        .rule-info {
            flex: 1;
        }

        .rule-name {
            font-weight: 500;
            color: var(--text-color);
        }

        .rule-description {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .rule-severity {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 10px;
        }

        .severity-high { background-color: var(--danger-color); color: white; }
        .severity-medium { background-color: var(--warning-color); color: white; }
        .severity-low { background-color: var(--success-color); color: white; }

        /* Progress Section */
        .progress-section {
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            margin: 10px 0;
            font-weight: 500;
        }

        /* Results Section */
        .results-section {
            display: none;
        }

        .results-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-button {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: var(--text-color);
        }

        .tab-button.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            margin: 5px;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1976D2;
        }

        .btn-secondary {
            background-color: var(--border-color);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: #ddd;
        }

        .btn-success {
            background-color: var(--success-color);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }

        /* Chat Interface */
        .chat-section {
            background-color: var(--surface-color);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .chat-messages {
            height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
            background-color: var(--background-color);
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 6px;
        }

        .chat-message.user {
            background-color: var(--primary-color);
            color: white;
            margin-left: 20%;
        }

        .chat-message.ai {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            margin-right: 20%;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background-color: var(--surface-color);
            color: var(--text-color);
        }

        /* Debug Log Styles */
        .debug-log-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            border-top: 2px solid #444;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            z-index: 9999;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
        }

        .debug-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            background-color: #333;
            border-bottom: 1px solid #555;
            font-weight: bold;
        }

        .debug-log-controls {
            display: flex;
            gap: 5px;
        }

        .debug-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            background-color: #555;
            color: white;
            font-size: 11px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .debug-btn:hover {
            background-color: #666;
        }

        .debug-log-area {
            height: 150px;
            overflow-y: auto;
            padding: 10px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .rule-categories {
                grid-template-columns: 1fr;
            }

            .analysis-summary {
                grid-template-columns: repeat(2, 1fr);
            }

            .chat-message.user {
                margin-left: 10%;
            }

            .chat-message.ai {
                margin-right: 10%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-title">ğŸ”§ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ­£è¦åŒ–AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ</div>
            <div class="header-subtitle">AIåˆ†æ Ã— 100ç¨®é¡ãƒ«ãƒ¼ãƒ« Ã— Geminié€£æºã§æœ€é©ãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ­£è¦åŒ–ã‚’å®Ÿç¾</div>
            
            <div class="account-selector" id="accountSelector">
                <button id="googleSignInBtn" class="debug-btn" style="background-color: #4285f4; color: white;">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
            </div>
        </header>

        <!-- Step 1: Database Upload -->
        <div class="workflow-section">
            <div class="section-header">
                <div class="section-number">1</div>
                <div class="section-title">ğŸ“‚ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</div>
            </div>
            
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <div>SQLiteãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
                <div class="file-input">
                    <input type="file" id="fileInput" accept=".db,.sqlite,.sqlite3" />
                    <div>ã¾ãŸã¯</div>
                    <select id="sampleDbSelect">
                        <option value="">ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é¸æŠ...</option>
                        <option value="beauty_sample.db">Beauty Sample (ç¾å®¹æ¥­ç•Œ)</option>
                        <option value="finance_sample.db">Finance Sample (é‡‘èæ¥­ç•Œ)</option>
                        <option value="manufacturing_sample.db">Manufacturing Sample (è£½é€ æ¥­ç•Œ)</option>
                        <option value="retail_sample.db">Retail Sample (å°å£²æ¥­ç•Œ)</option>
                        <option value="test_database.db">Test Database (ãƒ†ã‚¹ãƒˆç”¨)</option>
                    </select>
                </div>
                <button class="btn btn-primary" id="analyzeBtn" disabled>ğŸ” AIåˆ†æé–‹å§‹</button>
            </div>

            <div class="analysis-results" id="analysisResults">
                <h4>ğŸ“Š åˆ†æçµæœ</h4>
                <div class="analysis-summary" id="analysisSummary">
                    <!-- Analysis summary cards will be populated here -->
                </div>
                <div id="geminiRecommendations">
                    <!-- Gemini AI recommendations will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Step 2: Rule Selection -->
        <div class="workflow-section" style="display: none;" id="ruleSelectionSection">
            <div class="section-header">
                <div class="section-number">2</div>
                <div class="section-title">âš™ï¸ æ­£è¦åŒ–ãƒ«ãƒ¼ãƒ«é¸æŠ</div>
            </div>
            
            <div style="margin-bottom: 15px;">
                <button class="btn btn-secondary" id="selectAllBtn">âœ… å…¨é¸æŠ</button>
                <button class="btn btn-secondary" id="selectRecommendedBtn">ğŸ¯ æ¨å¥¨ã®ã¿é¸æŠ</button>
                <button class="btn btn-secondary" id="clearSelectionBtn">âŒ é¸æŠè§£é™¤</button>
                <span id="selectionCount" style="margin-left: 15px; font-weight: bold;">é¸æŠä¸­: 0/100</span>
            </div>

            <div class="rule-categories" id="ruleCategories">
                <!-- Rule categories will be populated here -->
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-success" id="applyRulesBtn" disabled>ğŸš€ æ­£è¦åŒ–å®Ÿè¡Œ</button>
            </div>
        </div>

        <!-- Step 3: Progress -->
        <div class="workflow-section progress-section" id="progressSection">
            <div class="section-header">
                <div class="section-number">3</div>
                <div class="section-title">â³ æ­£è¦åŒ–å‡¦ç†ä¸­</div>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">å‡¦ç†ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...</div>
        </div>

        <!-- Step 4: Results -->
        <div class="workflow-section results-section" id="resultsSection">
            <div class="section-header">
                <div class="section-number">4</div>
                <div class="section-title">ğŸ“‹ æ­£è¦åŒ–çµæœ</div>
            </div>
            
            <div class="results-tabs">
                <button class="tab-button active" data-tab="summary">ğŸ“Š ã‚µãƒãƒªãƒ¼</button>
                <button class="tab-button" data-tab="details">ğŸ“ è©³ç´°</button>
                <button class="tab-button" data-tab="sql">ğŸ’¾ å®Ÿè¡ŒSQL</button>
                <button class="tab-button" data-tab="report">ğŸ“„ ãƒ¬ãƒãƒ¼ãƒˆ</button>
            </div>

            <div class="tab-content active" id="summaryTab">
                <!-- Summary content -->
            </div>
            <div class="tab-content" id="detailsTab">
                <!-- Details content -->
            </div>
            <div class="tab-content" id="sqlTab">
                <!-- SQL content -->
            </div>
            <div class="tab-content" id="reportTab">
                <!-- Report content -->
            </div>

            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" id="downloadReportBtn">ğŸ“¥ ãƒ¬ãƒãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                <button class="btn btn-warning" id="generateLogBtn">ğŸ“‹ ãƒ­ã‚°ç”Ÿæˆ</button>
                <button class="btn btn-secondary" id="resetBtn">ğŸ”„ æœ€åˆã‹ã‚‰ã‚„ã‚Šç›´ã—</button>
            </div>
        </div>

        <!-- Chat Interface -->
        <div class="chat-section">
            <div class="section-header">
                <div class="section-number">ğŸ’¬</div>
                <div class="section-title">AIç›¸è«‡ãƒãƒ£ãƒƒãƒˆ</div>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message ai">
                    <strong>AI:</strong> ã“ã‚“ã«ã¡ã¯ï¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ­£è¦åŒ–ã«ã¤ã„ã¦ä½•ã‹ã”è³ªå•ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
                </div>
            </div>
            
            <div class="chat-input-area">
                <input type="text" class="chat-input" id="chatInput" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." />
                <button class="btn btn-primary" id="sendChatBtn">é€ä¿¡</button>
            </div>
        </div>
    </div>

    <!-- ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚¨ãƒªã‚¢ -->
    <div id="debugLogContainer" class="debug-log-container">
        <div class="debug-log-header">
            <span>ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</span>
            <span id="versionInfo" style="color: #0066cc; font-size: 14px; font-weight: bold; margin-left: 15px; padding: 2px 6px; background: #e6f3ff; border-radius: 3px;">v2025.07.23-db-agent</span>
            <div class="debug-log-controls">
                <button id="clearLogBtn" class="debug-btn">ã‚¯ãƒªã‚¢</button>
                <button id="copyLogBtn" class="debug-btn">ã‚³ãƒ”ãƒ¼</button>
                <button id="resetDataBtn" class="debug-btn">ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
                <button id="firebaseToggleBtn" class="debug-btn">Firebase: ON</button>
            </div>
        </div>
        <div id="debugLogArea" class="debug-log-area"></div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // ãƒ“ãƒ«ãƒ‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³
        const BUILD_VERSION = '2025.07.23-db-agent';
        
        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "your-project.firebaseapp.com",
            databaseURL: "https://your-project-default-rtdb.firebaseio.com",
            projectId: "your-project",
            storageBucket: "your-project.firebasestorage.app",
            messagingSenderId: "123456789",
            appId: "1:123456789:web:abcdef1234567890"
        };

        // FirebaseåˆæœŸåŒ–
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        const dataRef = database.ref('db-agent-data');
        let useFirebase = true;

        // æ­£è¦åŒ–ãƒ«ãƒ¼ãƒ«
        let normalizationRules = {};
        let selectedRules = [];
        let analysisData = {};
        let currentDatabase = null;

        // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¯ãƒ©ã‚¹
        class DbNormalizationAgent {
            constructor() {
                this.currentUser = null;
                this.currentAccount = 'guest';
                this.debugLog = [];
                this.setupAuth();
                this.init();
                this.loadNormalizationRules();
            }

            init() {
                this.log('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ­£è¦åŒ–AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆæœŸåŒ–é–‹å§‹', { version: BUILD_VERSION });
                
                document.getElementById('versionInfo').textContent = `v${BUILD_VERSION}`;
                
                this.setupEventListeners();
                this.setupDebugLog();
                this.log('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–å®Œäº†');
            }

            log(message, data = null) {
                const timestamp = new Date().toLocaleTimeString('ja-JP');
                const logEntry = {
                    timestamp: timestamp,
                    message: message,
                    data: data
                };
                
                this.debugLog.push(logEntry);
                console.log(`[${timestamp}] [DbAgent] ${message}`, data || '');
                
                this.updateDebugLogDisplay();
            }

            setupEventListeners() {
                // File upload
                document.getElementById('fileInput').addEventListener('change', (e) => this.handleFileSelect(e));
                document.getElementById('sampleDbSelect').addEventListener('change', (e) => this.handleSampleDbSelect(e));
                document.getElementById('analyzeBtn').addEventListener('click', () => this.analyzeDatabase());

                // Upload area drag & drop
                const uploadArea = document.getElementById('uploadArea');
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('dragover');
                });
                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('dragover');
                });
                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('dragover');
                    this.handleFileDrop(e);
                });

                // Rule selection
                document.getElementById('selectAllBtn').addEventListener('click', () => this.selectAllRules());
                document.getElementById('selectRecommendedBtn').addEventListener('click', () => this.selectRecommendedRules());
                document.getElementById('clearSelectionBtn').addEventListener('click', () => this.clearSelection());
                document.getElementById('applyRulesBtn').addEventListener('click', () => this.applyNormalization());

                // Results
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.addEventListener('click', (e) => this.switchTab(e.target.dataset.tab));
                });
                document.getElementById('downloadReportBtn').addEventListener('click', () => this.downloadReport());
                document.getElementById('generateLogBtn').addEventListener('click', () => this.generateLog());
                document.getElementById('resetBtn').addEventListener('click', () => this.resetApplication());

                // Chat
                document.getElementById('sendChatBtn').addEventListener('click', () => this.sendChatMessage());
                document.getElementById('chatInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendChatMessage();
                });
            }

            setupAuth() {
                this.log('Googleèªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–');

                auth.onAuthStateChanged((user) => {
                    this.currentUser = user;
                    if (user) {
                        this.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ', { 
                            uid: user.uid, 
                            email: user.email,
                            displayName: user.displayName
                        });
                        this.currentAccount = user.uid;
                        this.updateAccountUI(user);
                    } else {
                        this.log('âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ');
                        this.currentAccount = 'guest';
                        this.updateAccountUI(null);
                    }
                });

                document.getElementById('googleSignInBtn').addEventListener('click', () => {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    auth.signInWithPopup(provider).catch((error) => {
                        this.log('Googleèªè¨¼ã‚¨ãƒ©ãƒ¼', error);
                    });
                });
            }

            updateAccountUI(user) {
                const accountSelector = document.getElementById('accountSelector');
                
                if (user) {
                    accountSelector.innerHTML = `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            ${user.photoURL ? `<img src="${user.photoURL}" alt="Profile" style="width: 32px; height: 32px; border-radius: 50%;">` : ''}
                            <span style="color: #4285f4; font-weight: bold;">
                                âœ… ${user.displayName || user.email}
                            </span>
                            <button onclick="auth.signOut()" class="debug-btn" style="background-color: #dc3545;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
                        </div>
                    `;
                } else {
                    accountSelector.innerHTML = `
                        <button id="googleSignInBtn" class="debug-btn" style="background-color: #4285f4; color: white;">Googleã§ãƒ­ã‚°ã‚¤ãƒ³</button>
                    `;
                    document.getElementById('googleSignInBtn').addEventListener('click', () => {
                        const provider = new firebase.auth.GoogleAuthProvider();
                        auth.signInWithPopup(provider).catch((error) => {
                            this.log('Googleèªè¨¼ã‚¨ãƒ©ãƒ¼', error);
                        });
                    });
                }
            }

            async loadNormalizationRules() {
                try {
                    const response = await fetch('./normalization_rules.json');
                    normalizationRules = await response.json();
                    this.log('æ­£è¦åŒ–ãƒ«ãƒ¼ãƒ«ã‚’èª­ã¿è¾¼ã¿å®Œäº†', { categories: Object.keys(normalizationRules).length });
                    this.renderRuleCategories();
                } catch (error) {
                    this.log('æ­£è¦åŒ–ãƒ«ãƒ¼ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', error);
                }
            }

            renderRuleCategories() {
                const container = document.getElementById('ruleCategories');
                container.innerHTML = '';

                Object.entries(normalizationRules).forEach(([categoryId, category]) => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'rule-category';
                    
                    categoryDiv.innerHTML = `
                        <div class="category-header" onclick="this.parentElement.classList.toggle('expanded')">
                            <div class="category-title">${category.category}</div>
                            <div class="category-count">${category.rules.length}</div>
                        </div>
                        <div class="rule-list">
                            ${category.rules.map(rule => `
                                <div class="rule-item">
                                    <input type="checkbox" class="rule-checkbox" data-rule-id="${rule.id}" 
                                           onchange="dbAgent.updateRuleSelection()">
                                    <div class="rule-info">
                                        <div class="rule-name">${rule.name}</div>
                                        <div class="rule-description">${rule.description}</div>
                                    </div>
                                    <span class="rule-severity severity-${rule.severity}">${rule.severity.toUpperCase()}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    container.appendChild(categoryDiv);
                });
            }

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    currentDatabase = file;
                    document.getElementById('analyzeBtn').disabled = false;
                    this.log('ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ', { name: file.name, size: file.size });
                }
            }

            handleSampleDbSelect(event) {
                const selected = event.target.value;
                if (selected) {
                    currentDatabase = selected;
                    document.getElementById('analyzeBtn').disabled = false;
                    this.log('ã‚µãƒ³ãƒ—ãƒ«DBé¸æŠ', { db: selected });
                }
            }

            handleFileDrop(event) {
                const files = event.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.name.endsWith('.db') || file.name.endsWith('.sqlite') || file.name.endsWith('.sqlite3')) {
                        currentDatabase = file;
                        document.getElementById('fileInput').files = files;
                        document.getElementById('analyzeBtn').disabled = false;
                        this.log('ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‰ãƒ­ãƒƒãƒ—', { name: file.name, size: file.size });
                    }
                }
            }

            async analyzeDatabase() {
                this.log('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ†æé–‹å§‹');
                document.getElementById('analysisResults').style.display = 'block';
                
                try {
                    // ã‚µãƒ¼ãƒãƒ¼APIå‘¼ã³å‡ºã—
                    const requestData = {};
                    if (currentDatabase instanceof File) {
                        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                        const formData = new FormData();
                        formData.append('database', currentDatabase);
                        
                        const uploadResponse = await fetch('http://localhost:3005/api/upload-database', {
                            method: 'POST',
                            body: formData
                        });
                        
                        if (!uploadResponse.ok) {
                            throw new Error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        }
                        
                        const uploadResult = await uploadResponse.json();
                        requestData.filePath = uploadResult.path;
                        this.log('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†', uploadResult);
                        
                    } else if (typeof currentDatabase === 'string') {
                        // ã‚µãƒ³ãƒ—ãƒ«DBé¸æŠ
                        requestData.sampleDb = currentDatabase;
                    }
                    
                    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ†æAPIå‘¼ã³å‡ºã—
                    const analysisResponse = await fetch('http://localhost:3005/api/analyze-database', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
                    
                    if (!analysisResponse.ok) {
                        throw new Error('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                    
                    const analysisResult = await analysisResponse.json();
                    analysisData = analysisResult.analysis;
                    
                    this.renderAnalysisSummary(analysisData);
                    this.renderGeminiRecommendations(analysisResult.geminiRecommendations);
                    
                    // ãƒ«ãƒ¼ãƒ«é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
                    document.getElementById('ruleSelectionSection').style.display = 'block';
                    
                    this.log('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ†æå®Œäº†', analysisData);
                    
                } catch (error) {
                    this.log('åˆ†æã‚¨ãƒ©ãƒ¼', error.message);
                    alert('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            }

            async callGeminiAnalysis() {
                try {
                    this.log('Gemini AIåˆ†æé–‹å§‹');
                    
                    // MCP Gemini-CLI ã‚’ä½¿ç”¨ã—ã¦AIåˆ†æ
                    const prompt = `
                    ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ†æçµæœã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ï¼š
                    - ãƒ†ãƒ¼ãƒ–ãƒ«æ•°: ${analysisData.tables}
                    - ã‚«ãƒ©ãƒ æ•°: ${analysisData.columns}
                    - ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°: ${analysisData.records}
                    - æ¤œå‡ºã•ã‚ŒãŸå•é¡Œ: ${analysisData.issues}
                    
                    æ­£è¦åŒ–ã®æ¨å¥¨äº‹é …ã‚’3ã¤æ•™ãˆã¦ãã ã•ã„ã€‚ç°¡æ½”ã«ãŠé¡˜ã„ã—ã¾ã™ã€‚
                    `;
                    
                    // Note: å®Ÿéš›ã®MCPå‘¼ã³å‡ºã—ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™
                    const mockRecommendations = [
                        "ãƒ‡ãƒ¼ã‚¿å‹ã®çµ±ä¸€åŒ–ãŒå¿…è¦ã§ã™",
                        "NULLå€¤ã®å‡¦ç†ã‚’æ”¹å–„ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™", 
                        "ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®æœ€é©åŒ–ã«ã‚ˆã‚Šæ€§èƒ½å‘ä¸ŠãŒæœŸå¾…ã§ãã¾ã™"
                    ];
                    
                    this.renderGeminiRecommendations(mockRecommendations);
                    this.log('Gemini AIåˆ†æå®Œäº†');
                    
                } catch (error) {
                    this.log('Geminiåˆ†æã‚¨ãƒ©ãƒ¼', error);
                }
            }

            renderAnalysisSummary(analysis) {
                const container = document.getElementById('analysisSummary');
                const totalColumns = analysis.tables.reduce((sum, table) => sum + table.columns.length, 0);
                const totalIssues = analysis.issues.length;
                
                container.innerHTML = `
                    <div class="summary-card">
                        <div class="summary-number">${analysis.tables.length}</div>
                        <div class="summary-label">ãƒ†ãƒ¼ãƒ–ãƒ«æ•°</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number">${totalColumns}</div>
                        <div class="summary-label">ã‚«ãƒ©ãƒ æ•°</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number">${analysis.totalRecords}</div>
                        <div class="summary-label">ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number">${totalIssues}</div>
                        <div class="summary-label">æ¤œå‡ºå•é¡Œ</div>
                    </div>
                `;
            }

            renderGeminiRecommendations(recommendations) {
                const container = document.getElementById('geminiRecommendations');
                container.innerHTML = `
                    <h5>ğŸ¤– AIæ¨å¥¨äº‹é …</h5>
                    <ul>
                        ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                    </ul>
                `;
            }

            updateRuleSelection() {
                const checkboxes = document.querySelectorAll('.rule-checkbox:checked');
                selectedRules = Array.from(checkboxes).map(cb => cb.dataset.ruleId);
                
                document.getElementById('selectionCount').textContent = `é¸æŠä¸­: ${selectedRules.length}/100`;
                document.getElementById('applyRulesBtn').disabled = selectedRules.length === 0;
                
                this.log('ãƒ«ãƒ¼ãƒ«é¸æŠæ›´æ–°', { count: selectedRules.length });
            }

            selectAllRules() {
                document.querySelectorAll('.rule-checkbox').forEach(cb => cb.checked = true);
                this.updateRuleSelection();
            }

            selectRecommendedRules() {
                // æ¨å¥¨ãƒ«ãƒ¼ãƒ«ï¼ˆé«˜é‡è¦åº¦ï¼‰ã®ã¿é¸æŠ
                document.querySelectorAll('.rule-checkbox').forEach(cb => {
                    const ruleItem = cb.closest('.rule-item');
                    const severityElement = ruleItem.querySelector('.severity-high');
                    cb.checked = !!severityElement;
                });
                this.updateRuleSelection();
            }

            clearSelection() {
                document.querySelectorAll('.rule-checkbox').forEach(cb => cb.checked = false);
                this.updateRuleSelection();
            }

            async applyNormalization() {
                this.log('æ­£è¦åŒ–å‡¦ç†é–‹å§‹', { selectedRules: selectedRules.length });
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
                document.getElementById('progressSection').style.display = 'block';
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼é€²è¡Œã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                await this.simulateProgress();
                
                // çµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
                document.getElementById('resultsSection').style.display = 'block';
                document.getElementById('progressSection').style.display = 'none';
                
                this.renderResults();
                this.log('æ­£è¦åŒ–å‡¦ç†å®Œäº†');
            }

            async simulateProgress() {
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                
                const steps = [
                    "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã‚’è§£æä¸­...",
                    "é¸æŠã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨ä¸­...",
                    "ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã‚’ãƒã‚§ãƒƒã‚¯ä¸­...",
                    "æ­£è¦åŒ–ã‚’å®Ÿè¡Œä¸­...",
                    "çµæœã‚’ç”Ÿæˆä¸­..."
                ];
                
                for (let i = 0; i < steps.length; i++) {
                    progressText.textContent = steps[i];
                    progressFill.style.width = `${(i + 1) * 20}%`;
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }

            renderResults() {
                // ã‚µãƒãƒªãƒ¼ã‚¿ãƒ–
                document.getElementById('summaryTab').innerHTML = `
                    <h4>âœ… æ­£è¦åŒ–å®Œäº†</h4>
                    <p>é¸æŠã•ã‚ŒãŸ ${selectedRules.length} å€‹ã®ãƒ«ãƒ¼ãƒ«ãŒæ­£å¸¸ã«é©ç”¨ã•ã‚Œã¾ã—ãŸã€‚</p>
                    <div class="analysis-summary">
                        <div class="summary-card">
                            <div class="summary-number">${selectedRules.length}</div>
                            <div class="summary-label">é©ç”¨ãƒ«ãƒ¼ãƒ«</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-number">${Math.floor(Math.random() * 100)}%</div>
                            <div class="summary-label">å“è³ªæ”¹å–„</div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-number">${Math.floor(Math.random() * 50)}%</div>
                            <div class="summary-label">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š</div>
                        </div>
                    </div>
                `;

                // è©³ç´°ã‚¿ãƒ–
                document.getElementById('detailsTab').innerHTML = `
                    <h4>é©ç”¨ã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«</h4>
                    <ul>
                        ${selectedRules.map(ruleId => `<li>ãƒ«ãƒ¼ãƒ« ${ruleId} ãŒé©ç”¨ã•ã‚Œã¾ã—ãŸ</li>`).join('')}
                    </ul>
                `;

                // SQLã‚¿ãƒ–
                document.getElementById('sqlTab').innerHTML = `
                    <h4>å®Ÿè¡Œã•ã‚ŒãŸSQL</h4>
                    <pre style="background: #f5f5f5; padding: 15px; border-radius: 6px; overflow-x: auto;">
-- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ­£è¦åŒ–SQL
ALTER TABLE example_table MODIFY COLUMN name VARCHAR(255);
UPDATE example_table SET name = TRIM(name);
CREATE INDEX idx_example_name ON example_table(name);
-- ${selectedRules.length} å€‹ã®ãƒ«ãƒ¼ãƒ«ã«åŸºã¥ãå¤‰æ›´ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ
                    </pre>
                `;

                // ãƒ¬ãƒãƒ¼ãƒˆã‚¿ãƒ–
                document.getElementById('reportTab').innerHTML = `
                    <h4>ğŸ“„ æ­£è¦åŒ–ãƒ¬ãƒãƒ¼ãƒˆ</h4>
                    <p>æ—¥æ™‚: ${new Date().toLocaleString('ja-JP')}</p>
                    <p>ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: ${currentDatabase?.name || currentDatabase}</p>
                    <p>é©ç”¨ãƒ«ãƒ¼ãƒ«æ•°: ${selectedRules.length}</p>
                    <p>å‡¦ç†çŠ¶æ³: æ­£å¸¸å®Œäº†</p>
                `;
            }

            switchTab(tabName) {
                // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                // ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºã‚’æ›´æ–°
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(`${tabName}Tab`).classList.add('active');

                this.log('ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ', { tab: tabName });
            }

            async sendChatMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (!message) return;

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                this.addChatMessage('user', message);
                input.value = '';

                this.log('ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡', { message });

                try {
                    // ã‚µãƒ¼ãƒãƒ¼APIçµŒç”±ã§Gemini AIã«ç›¸è«‡
                    const response = await fetch('http://localhost:3005/api/chat-query', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            message: message,
                            context: {
                                currentDatabase: currentDatabase?.name || currentDatabase,
                                analysisData: analysisData,
                                selectedRules: selectedRules
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('ãƒãƒ£ãƒƒãƒˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                    
                    const result = await response.json();
                    this.addChatMessage('ai', result.response);
                    
                } catch (error) {
                    this.addChatMessage('ai', 'ã™ã¿ã¾ã›ã‚“ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
                    this.log('ãƒãƒ£ãƒƒãƒˆã‚¨ãƒ©ãƒ¼', error.message);
                }
            }

            async callGeminiChat(message) {
                // å®Ÿéš›ã®MCP Gemini-CLIå‘¼ã³å‡ºã—ã®ãƒ¢ãƒƒã‚¯
                const responses = [
                    "æ­£è¦åŒ–ã«ã¤ã„ã¦è©³ã—ãèª¬æ˜ã„ãŸã—ã¾ã™ã€‚ã©ã®éƒ¨åˆ†ã«ãŠå›°ã‚Šã§ã™ã‹ï¼Ÿ",
                    "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å“è³ªå‘ä¸Šã®ãŸã‚ã«ã¯ã€æ®µéšçš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚",
                    "é¸æŠã•ã‚ŒãŸãƒ«ãƒ¼ãƒ«ã«ã¤ã„ã¦ã€å…·ä½“çš„ãªåŠ¹æœã‚’ã”èª¬æ˜ã—ã¾ã™ã€‚",
                    "ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ”¹å–„ãŒæœŸå¾…ã§ãã‚‹é ˜åŸŸã‚’ç‰¹å®šã—ã¾ã—ãŸã€‚"
                ];
                
                return responses[Math.floor(Math.random() * responses.length)];
            }

            addChatMessage(sender, message) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${sender}`;
                messageDiv.innerHTML = `<strong>${sender === 'user' ? 'ã‚ãªãŸ' : 'AI'}:</strong> ${message}`;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            downloadReport() {
                const reportData = {
                    timestamp: new Date().toISOString(),
                    database: currentDatabase?.name || currentDatabase,
                    appliedRules: selectedRules,
                    analysisData: analysisData,
                    results: "æ­£è¦åŒ–å‡¦ç†ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ"
                };

                const blob = new Blob([JSON.stringify(reportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `db_normalization_report_${new Date().toISOString().slice(0, 10)}.json`;
                a.click();

                this.log('ãƒ¬ãƒãƒ¼ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†');
            }

            async generateLog() {
                try {
                    this.log('ãƒ­ã‚°ç”Ÿæˆé–‹å§‹');
                    
                    // ã‚µãƒ¼ãƒãƒ¼APIçµŒç”±ã§ãƒ­ã‚°ç”Ÿæˆï¼ˆç¬¬3åŸå‰‡æº–æ‹ ï¼‰
                    const response = await fetch('http://localhost:3005/api/generate-log', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            logData: this.debugLog,
                            sessionInfo: {
                                user: this.currentUser?.email || 'guest',
                                database: currentDatabase?.name || currentDatabase,
                                selectedRules: selectedRules.length,
                                analysisData: analysisData
                            }
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('ãƒ­ã‚°ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                    
                    const result = await response.json();
                    this.log('ãƒ­ã‚°ç”Ÿæˆå®Œäº†', result);
                    
                    // ã‚µãƒ¼ãƒãƒ¼ç”Ÿæˆãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    const downloadResponse = await fetch(`http://localhost:3005/logs/${result.logFile}`);
                    const logContent = await downloadResponse.text();
                    
                    const blob = new Blob([logContent], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = result.logFile;
                    a.click();
                    
                } catch (error) {
                    this.log('ãƒ­ã‚°ç”Ÿæˆã‚¨ãƒ©ãƒ¼', error.message);
                    alert('ãƒ­ã‚°ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                }
            }

            resetApplication() {
                if (confirm('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã™ã¹ã¦ã®é€²è¡ŒçŠ¶æ³ãŒå¤±ã‚ã‚Œã¾ã™ã€‚')) {
                    location.reload();
                }
            }

            setupDebugLog() {
                document.getElementById('clearLogBtn').addEventListener('click', () => {
                    this.debugLog = [];
                    this.updateDebugLogDisplay();
                });
                
                document.getElementById('copyLogBtn').addEventListener('click', () => {
                    const logText = this.debugLog.map(entry => {
                        const dataStr = entry.data ? ' | ' + JSON.stringify(entry.data) : '';
                        return `[${entry.timestamp}] ${entry.message}${dataStr}`;
                    }).join('\n');
                    
                    navigator.clipboard.writeText(logText).then(() => {
                        this.log('ãƒ­ã‚°ã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼å®Œäº†');
                    });
                });
                
                document.getElementById('resetDataBtn').addEventListener('click', () => {
                    if (confirm('ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                        localStorage.clear();
                        this.log('ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆå®Œäº†');
                        location.reload();
                    }
                });
                
                document.getElementById('firebaseToggleBtn').addEventListener('click', () => {
                    useFirebase = !useFirebase;
                    const btn = document.getElementById('firebaseToggleBtn');
                    btn.textContent = `Firebase: ${useFirebase ? 'ON' : 'OFF'}`;
                    btn.style.backgroundColor = useFirebase ? '#28a745' : '#dc3545';
                    this.log('Firebaseåˆ‡ã‚Šæ›¿ãˆ', { enabled: useFirebase });
                });
            }

            updateDebugLogDisplay() {
                const logArea = document.getElementById('debugLogArea');
                const logHTML = this.debugLog.map(entry => {
                    const dataStr = entry.data ? JSON.stringify(entry.data, null, 2) : '';
                    return `[${entry.timestamp}] ${entry.message}${dataStr ? '\n' + dataStr : ''}`;
                }).join('\n');
                
                logArea.textContent = logHTML;
                logArea.scrollTop = logArea.scrollHeight;
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
        let dbAgent;
        document.addEventListener('DOMContentLoaded', () => {
            dbAgent = new DbNormalizationAgent();
        });
    </script>
</body>
</html>